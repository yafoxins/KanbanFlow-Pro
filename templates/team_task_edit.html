<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Редактировать командную задачу — {{ username }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <!-- Quill.js -->
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <link
      href="{{ url_for('static', filename='style.css') }}"
      rel="stylesheet"
    />
  </head>
  <body>
    <!-- Topbar -->
    <header class="edit-topbar">
      <div class="edit-topbar-inner">
        <button class="edit-back-btn" onclick="goBack()">
          <span class="material-icons">arrow_back</span>
          <span>Назад к просмотру</span>
        </button>
        <div class="edit-topbar-title">
          <span class="material-icons">edit</span>
          <span>Редактировать задачу</span>
        </div>
        <button
          id="theme-toggle-btn"
          class="theme-toggle-btn"
          title="Переключить тему"
        >
          <span class="material-icons" id="theme-icon">dark_mode</span>
        </button>
      </div>
    </header>

    <main class="edit-main">
      <div class="edit-form-container">
        <form class="edit-form" id="task-edit-form" autocomplete="off">
          <input type="hidden" name="task_id" id="task_id" />

          <div class="edit-field">
            <label for="task_text">
              <span class="material-icons">title</span>
              Название задачи
            </label>
            <input
              type="text"
              name="task_text"
              id="task_text"
              placeholder="Название задачи"
              required
              maxlength="80"
            />
          </div>

          <div class="edit-field">
            <label for="task_status">
              <span class="material-icons">flag</span>
              Статус
            </label>
            <select name="task_status" id="task_status" required></select>
          </div>

          <div class="edit-field">
            <label for="task_assignee_input">
              <span class="material-icons">person</span>
              Исполнитель
            </label>
            <div class="assignee-input-container">
              <input
                type="text"
                id="task_assignee_input"
                placeholder="Исполнитель (ник)"
                autocomplete="off"
              />
              <input type="hidden" id="task_assignee" name="task_assignee" />
              <div
                id="assignee_autocomplete"
                class="autocomplete-list"
                style="display: none"
              ></div>
            </div>
          </div>

          <div class="edit-field">
            <label for="task_due_date">
              <span class="material-icons">event</span>
              Срок выполнения
            </label>
            <input
              type="date"
              name="task_due_date"
              id="task_due_date"
              class="date-input"
              placeholder="Выберите дату"
            />
          </div>

          <div class="edit-field">
            <label>
              <span class="material-icons">label</span>
              Теги
            </label>
            <div class="task-tags-select" id="tags_container"></div>
          </div>

          <div class="edit-field">
            <label for="task_description_editor">
              <span class="material-icons">description</span>
              Описание
            </label>
            <div id="task_description_editor"></div>
          </div>

          <div class="edit-actions">
            <button type="button" class="edit-cancel-btn" onclick="goBack()">
              <span class="material-icons">close</span>
              Отмена
            </button>
            <button type="submit" class="edit-save-btn">
              <span class="material-icons">save</span>
              Сохранить
            </button>
          </div>

          <div id="edit-error" class="edit-error-message"></div>
        </form>
      </div>
    </main>

    <script>
      const USERNAME = "{{ username }}";
      const TASK_ID = {{ task_id }};
      const TEAM_ID = {{ team_id if team_id is not none else 'null' }};
      let TASK_DATA = null;
      let STATUSES = [];
      let MEMBERS = [];
      let editQuill = null;

      // ===================== Theme =====================
      function setTheme(dark) {
        if (dark) {
          document.body.classList.add("dark");
          localStorage.setItem("kanban-theme", "dark");
          document.getElementById("theme-icon").innerText = "light_mode";
        } else {
          document.body.classList.remove("dark");
          localStorage.setItem("kanban-theme", "light");
          document.getElementById("theme-icon").innerText = "dark_mode";
        }
      }
      document.getElementById("theme-toggle-btn").onclick = function () {
        setTheme(!document.body.classList.contains("dark"));
      };
      (function () {
        const theme = localStorage.getItem("kanban-theme");
        setTheme(theme === "dark");
      })();

      // ===================== Загрузка данных =====================
      async function loadTaskData() {
        try {
          const taskResponse = await fetch(`/${USERNAME}/api/teams/${TEAM_ID}/tasks/${TASK_ID}/data`);
          if (!taskResponse.ok) {
            alert('Задача не найдена');
            goBack();
            return;
          }
          TASK_DATA = await taskResponse.json();

          // Загружаем статусы и участников команды
          const [statusesResponse, membersResponse] = await Promise.all([
            fetch(`/${USERNAME}/api/teams/${TEAM_ID}/statuses`),
            fetch(`/${USERNAME}/api/teams/${TEAM_ID}/members`)
          ]);
          STATUSES = await statusesResponse.json();
          const membersData = await membersResponse.json();
          MEMBERS = membersData.members || [];

          populateForm();
        } catch (error) {
          console.error('Ошибка загрузки данных:', error);
          alert('Ошибка загрузки данных');
        }
      }

      function populateForm() {
        document.getElementById('task_id').value = TASK_DATA.id;
        document.getElementById('task_text').value = TASK_DATA.text;

        // Статусы
        document.getElementById('task_status').innerHTML = STATUSES.map(status =>
          `<option value="${status.code}" ${status.code === TASK_DATA.status ? 'selected' : ''}>${status.title}</option>`
        ).join('');

        // Исполнитель
        let assigneeInput = document.getElementById('task_assignee_input');
        let assigneeHidden = document.getElementById('task_assignee');
        if (TASK_DATA.assignee_id && Array.isArray(MEMBERS)) {
          let member = MEMBERS.find((m) => m.username == TASK_DATA.assignee_id || m.id == TASK_DATA.assignee_id);
          assigneeInput.value = member ? member.username : '';
          assigneeHidden.value = member ? member.username : TASK_DATA.assignee_id;
        } else {
          assigneeInput.value = '';
          assigneeHidden.value = '';
        }

        // Настройка autocomplete для исполнителя
        setupAssigneeAutocomplete();

        // Дата
        document.getElementById('task_due_date').value = TASK_DATA.due_date ? TASK_DATA.due_date.slice(0, 10) : '';

        // Теги
        renderTags();

        // Описание
        initQuillEditor();
        if (editQuill) {
          editQuill.root.innerHTML = TASK_DATA.description || '';
        }
      }

      function setupAssigneeAutocomplete() {
        let assigneeInput = document.getElementById('task_assignee_input');
        let assigneeHidden = document.getElementById('task_assignee');

        assigneeInput.oninput = function () {
          let val = assigneeInput.value.toLowerCase();
          let list = MEMBERS.filter((m) => m && m.username && m.username.toLowerCase().includes(val));
          let ac = document.getElementById('assignee_autocomplete');
          if (!val || list.length === 0) {
            ac.style.display = 'none';
            assigneeHidden.value = '';
            return;
          }
          ac.innerHTML = list
            .map((m) => `<div class='autocomplete-item' data-id='${m.username}'>${m.username}</div>`)
            .join('');
          ac.style.display = 'block';
          ac.querySelectorAll('.autocomplete-item').forEach((item) => {
            item.onclick = function () {
              assigneeInput.value = item.textContent;
              assigneeHidden.value = item.dataset.id;
              ac.style.display = 'none';
            };
          });
        };

        assigneeInput.onblur = function () {
          setTimeout(() => {
            document.getElementById('assignee_autocomplete').style.display = 'none';
          }, 120);
        };
      }

      function renderTags() {
        const container = document.getElementById('tags_container');
        const availableTags = [
          { tag: 'Срочно', class: 'tag-sos' },
          { tag: 'Баг', class: 'tag-bug' },
          { tag: 'Улучшение', class: 'tag-feature' },
          { tag: 'Обсудить', class: 'tag-discuss' },
          { tag: 'Документы', class: 'tag-docs' }
        ];
        const selected = TASK_DATA.tags || [];

        container.innerHTML = availableTags.map(t =>
          `<span class="tag-badge ${t.class}${selected.includes(t.tag) ? ' selected' : ''}" data-tag="${t.tag}">${t.tag}</span>`
        ).join('');

        container.querySelectorAll('.tag-badge').forEach(badge => {
          badge.onclick = function () {
            badge.classList.toggle('selected');
          };
        });
      }

      function initQuillEditor() {
        const container = document.getElementById('task_description_editor');
        if (editQuill) {
          editQuill = null;
          container.innerHTML = '';
        }

        editQuill = new Quill('#task_description_editor', {
          theme: 'snow',
          modules: {
            toolbar: [
              ['bold', 'italic', 'underline', 'strike'],
              ['blockquote', 'code-block'],
              [{ 'header': 1 }, { 'header': 2 }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              [{ 'script': 'sub'}, { 'script': 'super' }],
              [{ 'indent': '-1'}, { 'indent': '+1' }],
              [{ 'direction': 'rtl' }],
              [{ 'size': ['small', false, 'large', 'huge'] }],
              [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'font': [] }],
              [{ 'align': [] }],
              ['clean'],
              ['link', 'image']
            ]
          },
          placeholder: 'Описание задачи...'
        });
      }

      // ===================== Обработчики =====================
      document.getElementById('task-edit-form').onsubmit = async function(e) {
        e.preventDefault();

        const formData = {
          text: document.getElementById('task_text').value.trim(),
          description: editQuill ? editQuill.root.innerHTML : '',
          status: document.getElementById('task_status').value,
          assignee_id: document.getElementById('task_assignee').value || null,
          due_date: document.getElementById('task_due_date').value || null,
          tags: Array.from(document.querySelectorAll('#tags_container .tag-badge.selected')).map(b => b.dataset.tag)
        };

        try {
          const response = await fetch(`/${USERNAME}/api/teams/${TEAM_ID}/tasks/${TASK_ID}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          });

          if (response.ok) {
            goBack();
          } else {
            const data = await response.json();
            document.getElementById('edit-error').innerText = data.error || 'Ошибка сохранения';
          }
        } catch (error) {
          document.getElementById('edit-error').innerText = 'Ошибка сохранения';
        }
      };

      function goBack() {
        // Если есть referrer и он содержит '/team_task/' (просмотр задачи), возвращаем на просмотр задачи
        if (document.referrer && document.referrer.includes('/team_task/') && !document.referrer.includes('/edit')) {
          window.location.href = document.referrer;
        } else if (typeof TEAM_ID !== "undefined" && TEAM_ID) {
          // Всегда возвращаем на командную доску, если не можем вернуться к просмотру задачи
          window.location.href = `/${USERNAME}/team?team_id=${TEAM_ID}`;
        } else {
          // fallback: просто на /USERNAME/team
          window.location.href = `/${USERNAME}/team`;
        }
      }

      // ===================== Вспомогательные функции =====================
      function escapeHTML(str) {
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      // Загружаем данные при загрузке страницы
      loadTaskData();
    </script>

    <style>
      body {
        min-height: 100vh;
        font-family: "Roboto", Arial, sans-serif;
        transition: background 0.3s;
      }
      .edit-topbar {
        background: #fff;
        box-shadow: none;
        border-bottom: none;
        padding: 0;
        margin-bottom: 0;
        position: sticky;
        top: 0;
        z-index: 20;
        min-height: 64px;
        transition: background 0.3s;
      }
      .edit-topbar::after {
        display: none !important;
      }
      .edit-topbar-inner {
        display: flex;
        align-items: center;
        justify-content: center;
        max-width: 820px;
        margin: 0 auto;
        padding: 0 18px;
        height: 64px;
        position: relative;
      }
      .edit-back-btn {
        display: flex;
        align-items: center;
        gap: 6px;
        background: none;
        border: none;
        color: #5271ff;
        font-weight: 700;
        font-size: 1.08em;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 8px;
        transition: background 0.15s;
        position: absolute;
        left: 32px;
        top: 12px;
        z-index: 2;
      }
      .edit-back-btn:hover {
        background: #f3f6ff;
      }
      .edit-topbar-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.45em;
        font-weight: 800;
        color: #222;
        justify-content: center;
        flex: 1;
        letter-spacing: -0.5px;
        z-index: 1;
        text-shadow: 0 1px 2px #0002;
      }
      .theme-toggle-btn {
        position: absolute;
        right: 32px;
        top: 12px;
        z-index: 2;
      }
      .edit-main {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 80vh;
        background: transparent;
        transition: background 0.3s;
        margin-top: 32px;
      }
      .edit-form-container {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 4px 32px #5271ff13, 0 1px 6px #0001;
        padding: 48px 56px 40px 56px;
        max-width: 900px;
        width: 100%;
        margin: 0 auto;
        transition: background 0.3s, color 0.3s;
      }
      .edit-form {
        display: flex;
        flex-direction: column;
        gap: 22px;
      }
      .edit-field {
        display: flex;
        flex-direction: column;
        gap: 7px;
      }
      .edit-field label {
        display: flex;
        align-items: center;
        gap: 7px;
        font-weight: 600;
        color: #5271ff;
        font-size: 1.04em;
        margin-bottom: 2px;
      }
      .edit-field input,
      .edit-field select {
        padding: 13px 14px;
        border: 2px solid #e3e7f0;
        border-radius: 10px;
        font-size: 1.08em;
        background: #f7f8fa;
        color: #222;
        transition: border 0.15s;
      }
      .edit-field input:focus,
      .edit-field select:focus {
        outline: none;
        border-color: #5271ff;
      }
      .edit-field select {
        appearance: none;
        background: #f7f8fa
          url('data:image/svg+xml;utf8,<svg fill="%235271ff" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>')
          no-repeat right 12px center/18px 18px;
      }
      .assignee-input-container {
        position: relative;
      }
      .autocomplete-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 2px solid #e3e7f0;
        border-top: none;
        border-radius: 0 0 10px 10px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
      }
      .autocomplete-item {
        padding: 12px;
        cursor: pointer;
        border-bottom: 1px solid #e3e7f0;
        color: #222;
      }
      .autocomplete-item:hover {
        background: #f3f6ff;
      }
      .autocomplete-item:last-child {
        border-bottom: none;
      }
      .task-tags-select {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .tag-badge {
        padding: 6px 14px;
        border-radius: 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
        background: #f7f8fa;
        user-select: none;
      }
      .tag-badge.selected {
        border-color: currentColor;
        background: #e3e7f0;
      }
      .tag-sos {
        background: #ffebee;
        color: #d32f2f;
      }
      .tag-bug {
        background: #fff3e0;
        color: #f57c00;
      }
      .tag-feature {
        background: #e3f2fd;
        color: #1976d2;
      }
      .tag-discuss {
        background: #f3e5f5;
        color: #7b1fa2;
      }
      .tag-docs {
        background: #e8f5e8;
        color: #388e3c;
      }
      #task_description_editor {
        min-height: 180px;
        border: 2px solid #e3e7f0;
        border-radius: 10px;
        background: #f7f8fa;
        margin-top: 2px;
      }
      .ql-toolbar.ql-snow {
        border-radius: 10px 10px 0 0;
        border: none;
        background: #f7f8fa;
        border-bottom: 1.5px solid #e3e7f0;
      }
      .ql-container.ql-snow {
        border: none;
        border-radius: 0 0 10px 10px;
        background: #f7f8fa;
      }
      .ql-editor {
        min-height: 120px;
        font-size: 1.08em;
        color: #222;
      }
      .edit-actions {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
        margin-top: 10px;
      }
      .edit-cancel-btn,
      .edit-save-btn {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 28px;
        border: none;
        border-radius: 10px;
        font-size: 1.08em;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s, color 0.15s;
      }
      .edit-cancel-btn {
        background: #f7f8fa;
        color: #5271ff;
        border: 2px solid #e3e7f0;
      }
      .edit-cancel-btn:hover {
        background: #f3f6ff;
        color: #222;
      }
      .edit-save-btn {
        background: #5271ff;
        color: #fff;
        border: 2px solid #5271ff;
      }
      .edit-save-btn:hover {
        background: #3956c4;
        border-color: #3956c4;
      }
      .edit-error-message {
        color: #d32f2f;
        text-align: center;
        font-size: 14px;
        margin-top: 12px;
      }
      @media (max-width: 600px) {
        .edit-form-container {
          padding: 16px 4vw 18px 4vw;
        }
        .edit-topbar-inner {
          max-width: 100vw;
          padding: 0 4vw;
        }
      }
      .dark body {
        background: #181a20 !important;
      }
      .dark .edit-main {
        background: #181a20 !important;
      }
      .dark .edit-form-container {
        background: #23263a !important;
      }
      .dark .edit-form-container * {
        background: transparent !important;
      }
      .dark .edit-topbar {
        background: rgba(32, 34, 51, 0.98);
        box-shadow: 0 2px 12px #0008, 0 1px 4px #0004;
        backdrop-filter: blur(8px);
      }
      .dark .edit-topbar-title,
      .dark .edit-back-btn {
        color: #e6eaff;
        text-shadow: 0 1px 2px #0008;
      }
      .dark .edit-field label {
        color: #e6eaff;
      }
      .dark .edit-field input,
      .dark .edit-field select {
        background: #23263a;
        color: #e6eaff;
        border-color: #3a3f5c;
        box-shadow: 0 1px 2px #0002;
        transition: background 0.3s, color 0.3s;
      }
      .dark .edit-field input:focus,
      .dark .edit-field select:focus {
        border-color: #5271ff;
      }
      .dark .edit-field select {
        background: #23263a
          url('data:image/svg+xml;utf8,<svg fill="%23bfcfff" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>')
          no-repeat right 12px center/18px 18px;
      }
      .dark .tag-badge {
        background: #23263a;
        color: #e6eaff;
        border-color: #3a3f5c;
      }
      .dark .tag-badge.selected {
        background: #3a3f5c;
      }
      .dark #task_description_editor {
        background: #23263a;
        border-color: #3a3f5c;
      }
      .dark .ql-toolbar.ql-snow {
        background: #23263a;
        border-bottom: 1.5px solid #3a3f5c;
        color: #e6eaff;
        transition: background 0.3s, color 0.3s;
      }
      .dark .ql-container.ql-snow {
        background: #23263a;
        color: #e6eaff;
        transition: background 0.3s, color 0.3s;
      }
      .dark .ql-editor {
        color: #e6eaff;
      }
      .dark .edit-cancel-btn {
        background: #23263a;
        color: #e6eaff;
        border-color: #3a3f5c;
      }
      .dark .edit-cancel-btn:hover {
        background: #3a3f5c;
        color: #fff;
      }
      .dark .edit-save-btn {
        background: #5271ff;
        color: #fff;
        border: 2px solid #5271ff;
        box-shadow: 0 1px 2px #0002;
      }
      .dark .edit-save-btn:hover {
        background: #3956c4;
        border-color: #3956c4;
      }
    </style>
  </body>
</html>
