<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <title>Командная задача — {{ username }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet" />
  <!-- Quill.js -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quill.snow.css') }}">
  <script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>

  <!-- CSRF Token -->
  <script>
    // CSRF токен доступен через data-csrf-token в body

    // Глобальная функция для получения заголовков CSRF
    window.getHeaders = function (contentType = 'application/json') {
      const headers = {
        'X-CSRF-Token': document.body.getAttribute('data-csrf-token') || ''
      };
      if (contentType) headers['Content-Type'] = contentType;
      return headers;
    };
  </script>

  <style>
    /* === Комментарии === */
    .task-comments-section {
      margin-top: 32px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 2px 12px #5271ff0a;
      padding: 18px 18px 10px 18px;
    }

    .comments-title {
      font-size: 1.18em;
      font-weight: 700;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #comments-list {
      margin-bottom: 18px;
    }

    .comment-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      margin-bottom: 10px;
      background: #f8faff;
      border-radius: 10px;
      box-shadow: 0 1px 8px #5271ff0a;
      padding: 10px 14px 10px 10px;
    }

    .comment-avatar {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #e3e8ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.2em;
      overflow: hidden;
      box-shadow: 0 2px 8px #5271ff22;
    }

    .comment-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 50%;
    }

    .avatar-initial {
      color: #5271ff;
    }

    .comment-body {
      flex: 1;
    }

    .comment-meta {
      font-size: 0.98em;
      color: #5271ff;
      font-weight: 600;
      display: flex;
      gap: 10px;
      align-items: center;
      width: 100%;
    }

    .comment-author {
      color: #222;
      font-weight: 700;
    }

    .comment-date {
      color: #b9bccc;
      font-size: 0.93em;
      margin-left: auto;
      white-space: nowrap;
    }

    .comment-text {
      margin-top: 2px;
      font-size: 1.08em;
      color: #222;
      word-break: break-word;
    }

    .comment-delete-btn {
      background: none;
      border: none;
      color: #d11a2a;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 6px;
      transition: background 0.15s;
      display: flex;
      align-items: center;
      margin-left: 8px;
      margin-right: 0;
    }

    .comment-delete-btn:hover {
      background: #ffeaea;
    }

    .no-comments {
      color: #b9bccc;
      text-align: center;
      margin: 10px 0 16px 0;
    }

    .comment-form {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 18px;
      background: #f7f8fa;
      border-radius: 14px;
      box-shadow: 0 2px 12px #5271ff0a, 0 1px 4px #0001;
      padding: 18px 16px 14px 16px;
    }

    .comment-input-wrap {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #comment-input {
      min-height: 70px;
      font-size: 1.15em;
      padding: 14px 16px;
      border-radius: 10px;
      border: 1.5px solid #e3e7f0;
      background: #fff;
      box-shadow: 0 1px 4px #5271ff0a;
      resize: vertical;
      margin-bottom: 0;
    }

    .comment-form .btn-primary {
      width: 100%;
      margin: 0;
      font-size: 1.08em;
      padding: 12px 0;
      border-radius: 8px;
      box-shadow: 0 2px 8px #5271ff0a;
      background: linear-gradient(90deg, #7b5cff, #5271ff 80%);
      color: #fff;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: background 0.2s;
    }

    .comment-form .btn-primary:hover {
      background: linear-gradient(90deg, #5271ff, #7b5cff 80%);
    }

    .mention {
      color: #5271ff;
      background: #e3e8ff;
      border-radius: 6px;
      padding: 0 4px;
      font-weight: 700;
    }

    .mention-autocomplete {
      position: absolute;
      left: 0;
      top: 100%;
      z-index: 10;
      background: #fff;
      border: 1px solid #dbe2ff;
      border-radius: 8px;
      box-shadow: 0 2px 8px #5271ff22;
      min-width: 120px;
      max-width: 220px;
      max-height: 180px;
      overflow-y: auto;
      display: none;
    }

    .mention-item {
      padding: 7px 12px;
      cursor: pointer;
      color: #5271ff;
      font-weight: 600;
    }

    .mention-item:hover {
      background: #f3f6ff;
    }
  </style>
</head>

<body data-csrf-token="{{ csrf_token }}">
  <!-- Topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <div class="topbar-left">
        <span class="material-icons logo-icon">grid_view</span>
        <span class="logo-text">Team Kanban Board</span>
      </div>
    </div>
  </header>
  <div class="team-title-bar">
    <span class="team-title-main">{{ team_name }}</span>
  </div>

  <!-- Main Content -->
  <main class="task-view-main">
    <div class="task-view-bg-gradient"></div>
    <div class="task-view-center">
      <div class="task-view-card animated-fade-in">
        <div class="task-view-header">
          <button class="btn btn-secondary back-btn"
            onclick="window.location.href='/{{ username }}/team?team_id={{ team_id }}'">
            <span class="material-icons">arrow_back</span>
            Назад к команде
          </button>
          <div class="task-actions">
            <button class="btn edit-task-btn" id="edit-task-btn">
              <span class="material-icons">edit</span>
              Редактировать
            </button>
            <button class="btn btn-danger delete-task-btn" id="delete-task-btn">
              <span class="material-icons">delete</span>
              Удалить
            </button>
          </div>
        </div>
        <div class="task-inner-card">
          <div class="task-inner-header"
            style="display: flex; align-items: flex-start; justify-content: space-between; gap: 24px;">
            <div>
              <div class="task-view-title" id="task-title"></div>
              <div class="task-view-meta" id="task-meta"></div>
              <div class="task-view-tags" id="task-tags"></div>
            </div>
            <div class="task-view-assignee" id="task-assignee" style="min-width: 170px;"></div>
          </div>
          <div class="task-view-description">
            <div class="task-view-desc-title">Описание</div>
            <div class="task-description-content" id="task-desc"></div>
          </div>
          <!-- Блок комментариев -->
          <div class="task-comments-section">
            <h3 class="comments-title"><span class="material-icons">forum</span> Комментарии</h3>
            <div id="comments-list"></div>
            <form id="comment-form" class="comment-form">
              <div class="comment-input-wrap">
                <textarea id="comment-input"
                  placeholder="Напишите комментарий... Используйте @ для упоминания"></textarea>
                <div id="mention-autocomplete" class="mention-autocomplete"></div>
              </div>
              <button type="submit" class="btn btn-primary"><span class="material-icons">send</span>Отправить</button>
            </form>
          </div>
          <div class="task-view-info" id="task-info"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Модалка редактирования -->
  <div class="modal-backdrop" id="edit-modal" style="display: none">
    <div class="modal modal-task">
      <button class="modal-close" onclick="closeEditModal()" type="button" title="Закрыть">
        <span class="material-icons">close</span>
      </button>
      <div class="modal-title">Редактировать задачу</div>
      <form class="modal-form" id="edit-form" autocomplete="off">
        <input type="hidden" name="task_id" id="edit_task_id" />
        <div class="modal-field">
          <label for="edit_task_text"><span class="material-icons">title</span> Название задачи</label>
          <input type="text" name="task_text" id="edit_task_text" placeholder="Название задачи" required
            maxlength="80" />
        </div>
        <div class="modal-field">
          <label for="edit_task_status"><span class="material-icons">flag</span> Статус</label>
          <select name="task_status" id="edit_task_status" required></select>
        </div>
        <div class="modal-field">
          <label for="edit_task_assignee_input"><span class="material-icons">person</span> Исполнитель</label>
          <div class="modal-row" style="position: relative">
            <input type="text" id="edit_task_assignee_input" placeholder="Исполнитель (ник)" autocomplete="off"
              style="flex: 1" />
            <input type="hidden" id="edit_task_assignee" name="edit_task_assignee" />
            <div id="edit_assignee_autocomplete" class="autocomplete-list" style="display: none"></div>
          </div>
        </div>
        <div class="modal-field">
          <label class="date-label" for="edit_task_due_date"><span class="material-icons date-icon">event</span> Срок
            выполнения</label>
          <input type="date" name="task_due_date" id="edit_task_due_date" class="date-input"
            placeholder="Выберите дату" />
        </div>
        <div class="modal-field">
          <label><span class="material-icons">label</span> Теги</label>
          <div class="task-tags-select" id="edit_tags_container" style="margin-bottom: 8px"></div>
        </div>
        <div class="modal-field">
          <label for="edit_task_description_editor"><span class="material-icons">description</span> Описание</label>
          <div id="edit_task_description_editor" style="height: 200px"></div>
        </div>
        <div class="modal-actions">
          <button type="button" class="plus-btn cancel-btn" onclick="closeEditModal()">
            <span class="material-icons">close</span>Отмена
          </button>
          <button type="submit" class="plus-btn modal-save-btn">
            <span class="material-icons">save</span>Сохранить
          </button>
        </div>
        <div id="edit-error" class="modal-error"></div>
      </form>
    </div>
  </div>

  <!-- Модалка профиля -->
  <div class="modal-backdrop" id="profile-modal" style="display: none">
    <div class="modal profile-modal">
      <button class="modal-close" onclick="closeProfileModal()">
        &times;
      </button>
      <div class="modal-title">Профиль пользователя</div>
      <div class="profile-content">
        <div class="profile-avatar" id="profile-avatar-container">
          <img id="profile-avatar-img" class="profile-avatar-img"
            style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
          <span class="profile-avatar-initial" id="profile-avatar-initial">{{ username[0]|upper }}</span>
        </div>
        <div class="profile-avatar-actions" style="margin: 16px 0; display: flex; gap: 8px; justify-content: center;">
          <label for="avatar-upload" class="btn btn-secondary" style="cursor: pointer; margin: 0;">
            <span class="material-icons">photo_camera</span>
            Загрузить аватарку
          </label>
          <input type="file" id="avatar-upload" accept="image/*" style="display: none;" />
          <button class="btn btn-danger" id="delete-avatar-btn" style="display: none;">
            <span class="material-icons">delete</span>
            Удалить
          </button>
        </div>
        <div class="profile-info">
          <div class="profile-field">
            <label>Имя пользователя:</label>
            <span id="profile-username">{{ username }}</span>
          </div>
          <div class="profile-field">
            <label>Email:</label>
            <span id="profile-email">-</span>
          </div>
          <div class="profile-field">
            <label>Страна:</label>
            <span id="profile-country">-</span>
          </div>
          <div class="profile-field">
            <label>Полное имя:</label>
            <span id="profile-fullname">-</span>
          </div>
        </div>
      </div>
      <button class="profile-close" onclick="closeProfileModal()">
        Закрыть
      </button>
    </div>
  </div>

  <!-- Модалка смены пароля -->
  <div class="modal-backdrop" id="change-password-modal" style="display: none">
    <div class="modal">
      <button class="modal-close" onclick="closeChangePasswordModal()">
        &times;
      </button>
      <div class="modal-title">Сменить пароль</div>
      <form class="modal-form" id="change-password-form" autocomplete="off">
        <div class="modal-field">
          <label for="old_password">
            <span class="material-icons">lock</span> Текущий пароль
          </label>
          <input type="password" name="old_password" id="old_password" placeholder="Введите текущий пароль" required />
        </div>
        <div class="modal-field">
          <label for="new_password">
            <span class="material-icons">lock_outline</span> Новый пароль
          </label>
          <input type="password" name="new_password" id="new_password" placeholder="Введите новый пароль" required />
        </div>
        <div class="modal-field">
          <label for="new_password2">
            <span class="material-icons">lock_outline</span> Подтвердите
            пароль
          </label>
          <input type="password" name="new_password2" id="new_password2" placeholder="Повторите новый пароль"
            required />
        </div>
        <div class="modal-actions">
          <button type="button" class="cancel-btn" onclick="closeChangePasswordModal()">
            Отмена
          </button>
          <button type="submit" class="save-btn">
            <span class="material-icons">save</span>
            Сменить пароль
          </button>
        </div>
        <div id="change-password-error" class="modal-error"></div>
      </form>
    </div>
  </div>

  <script>
    let USERNAME = {{ username| tojson }};
    let TASK_ID = {{ task_id| tojson }};
    let TASK_DATA = null;
    let STATUSES = [];
    let MEMBERS = [];
    let TEAM_ID = null;
    let editQuill = null;

    // ===================== Загрузка данных =====================
    async function loadTaskData() {
      try {
        // Сначала найдем команду, к которой принадлежит задача
        const teamsResponse = await fetch(`/${USERNAME}/api/teams/list`, { headers: getHeaders() });
        const teamsData = await teamsResponse.json();
        const teams = teamsData.teams || [];

        // Ищем команду, в которой есть эта задача
        for (const team of teams) {
          const tasksResponse = await fetch(`/${USERNAME}/api/teams/${team.id}/tasks`, { headers: getHeaders() });
          const tasks = await tasksResponse.json();
          const task = tasks.find(t => t.id == TASK_ID);
          if (task) {
            TASK_DATA = task;
            TEAM_ID = team.id;
            break;
          }
        }

        if (!TASK_DATA) {
          document.getElementById('task-view-content').innerHTML =
            '<div class="error-message">Задача не найдена</div>';
          return;
        }

        await loadTeamData();
        renderTaskView();
      } catch (error) {
        document.getElementById('task-view-content').innerHTML =
          '<div class="error-message">Ошибка загрузки задачи</div>';
      }
    }

    async function loadTeamData() {
      try {
        const [statusesResponse, membersResponse] = await Promise.all([
          fetch(`/${USERNAME}/api/teams/${TEAM_ID}/statuses`, { headers: getHeaders() }),
          fetch(`/${USERNAME}/api/teams/${TEAM_ID}/members`, { headers: getHeaders() })
        ]);

        STATUSES = await statusesResponse.json();
        const membersData = await membersResponse.json();
        // Используем структуру с id и username из API
        MEMBERS = membersData.members || [];
      } catch (error) {
        STATUSES = [];
        MEMBERS = [];
      }
    }

    // ===================== Рендер задачи =====================
    function renderTaskView() {
      if (!TASK_DATA) return;
      document.getElementById('task-title').innerHTML = escapeHTML(TASK_DATA.text);
      document.getElementById('task-meta').innerHTML = `
        <span class="task-status-badge">${getStatusTitle(TASK_DATA.status)}</span>
        ${TASK_DATA.due_date ? `<span class="task-date-badge">${formatDate(TASK_DATA.due_date)}</span>` : ''}
      `;
      document.getElementById('task-tags').innerHTML = renderTags(TASK_DATA.tags);
      // Исполнитель
      let assigneeName = TASK_DATA.assignee_name;
      if ((!assigneeName || assigneeName === 'null') && TASK_DATA.assignee_id && Array.isArray(MEMBERS)) {
        const m = MEMBERS.find(mem => mem.username == TASK_DATA.assignee_id || mem.id == TASK_DATA.assignee_id);
        if (m) assigneeName = m.username;
      }
      let assigneeHtml = "";
      if (assigneeName) {
        const initial = escapeHTML(assigneeName[0].toUpperCase());
        assigneeHtml = `
          <div class="task-assignee-block">
            <div class="assignee-avatar" data-username="${escapeHTML(assigneeName)}">
              <span class="avatar-initial">${initial}</span>
            </div>
            <div class="assignee-info">
              <div class="assignee-label">Исполнитель</div>
              <div class="assignee-name">${escapeHTML(assigneeName)}</div>
            </div>
          </div>
        `;
      } else {
        assigneeHtml = `
          <div class="task-assignee-block not-assigned">
            <div class="assignee-avatar">
              <span class="material-icons">person_off</span>
            </div>
            <div class="assignee-info">
              <div class="assignee-label">Исполнитель</div>
              <div class="assignee-name not-assigned">Не назначено</div>
            </div>
          </div>
        `;
      }
      document.getElementById('task-assignee').innerHTML = assigneeHtml;

      // Загружаем аватарку для исполнителя если есть
      if (assigneeName) {
        loadUserAvatarForTask(document.getElementById('task-assignee'), assigneeName);
      }

      document.getElementById('task-desc').innerHTML = `<div class='task-desc-block'>${TASK_DATA.description || '<em>Описание отсутствует</em>'}</div>`;
      document.getElementById('task-info').innerHTML = `
        <div class="task-info-item"><span class="material-icons">person</span>Обновлено: ${TASK_DATA.updated_by_name || 'Неизвестно'}</div>
        <div class="task-info-item"><span class="material-icons">schedule</span>${formatDateTime(TASK_DATA.updated_at)}</div>
      `;
    }

    // Функция загрузки аватарки пользователя для карточки задачи
    async function loadUserAvatarForTask(taskElement, username) {
      try {
        const response = await fetch(`/api/avatar/${username}`, { headers: getHeaders() });
        const data = await response.json();

        if (data.avatar_url) {
          const avatarElement = taskElement.querySelector('.assignee-avatar');
          if (avatarElement) {
            // Создаем изображение аватарки
            const avatarImg = document.createElement('img');
            avatarImg.src = data.avatar_url;
            avatarImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 50%;';
            avatarImg.alt = username;

            // Очищаем содержимое и добавляем изображение
            avatarElement.innerHTML = '';
            avatarElement.appendChild(avatarImg);
          }
        }
      } catch (error) {
      }
    }

    // ===================== Редактирование =====================
    async function ensureTeamAndMembers() {
      if (!TEAM_ID && TASK_DATA) {
        // Найти команду по задаче
        const teamsResponse = await fetch(`/${USERNAME}/api/teams/list`, { headers: getHeaders() });
        const teamsData = await teamsResponse.json();
        const teams = teamsData.teams || [];
        for (const team of teams) {
          const tasksResponse = await fetch(`/${USERNAME}/api/teams/${team.id}/tasks`, { headers: getHeaders() });
          const tasks = await tasksResponse.json();
          if (tasks.find(t => t.id == TASK_ID)) {
            TEAM_ID = team.id;
            break;
          }
        }
      }
      if (TEAM_ID) {
        const membersResponse = await fetch(`/${USERNAME}/api/teams/${TEAM_ID}/members`, { headers: getHeaders() });
        const membersData = await membersResponse.json();
        // Используем структуру с id и username из API
        MEMBERS = membersData.members || [];
      }
    }

    function createQuillEditor() {
      // Удаляем старый редактор, если есть
      const container = document.getElementById('edit_task_description_editor');
      if (window.editQuill) window.editQuill = null;
      container.innerHTML = '';
      const newDiv = document.createElement('div');
      newDiv.id = 'quill-editor-inner';
      newDiv.style.height = '200px';
      container.appendChild(newDiv);
      window.editQuill = new Quill('#quill-editor-inner', {
        theme: 'snow',
        modules: {
          toolbar: [
            ['bold', 'italic', 'underline', 'strike'],
            ['blockquote', 'code-block'],
            [{ 'header': 1 }, { 'header': 2 }],
            [{ 'list': 'ordered' }, { 'list': 'bullet' }],
            [{ 'script': 'sub' }, { 'script': 'super' }],
            [{ 'indent': '-1' }, { 'indent': '+1' }],
            [{ 'direction': 'rtl' }],
            [{ 'size': ['small', false, 'large', 'huge'] }],
            [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
            [{ 'color': [] }, { 'background': [] }],
            [{ 'font': [] }],
            [{ 'align': [] }],
            ['clean'],
            ['link', 'image']
          ]
        },
        placeholder: 'Описание задачи...'
      });
    }

    async function openEditModal() {
      if (!TASK_DATA) return;
      await ensureTeamAndMembers();
      document.getElementById('edit_task_id').value = TASK_DATA.id;
      document.getElementById('edit_task_text').value = TASK_DATA.text;
      document.getElementById('edit_task_status').innerHTML = STATUSES.map(status =>
        `<option value="${status.code}" ${status.code === TASK_DATA.status ? 'selected' : ''}>${status.title}</option>`
      ).join('');
      document.getElementById('edit_task_due_date').value = TASK_DATA.due_date || '';
      // Исполнитель autocomplete
      let assigneeInput = document.getElementById('edit_task_assignee_input');
      let assigneeHidden = document.getElementById('edit_task_assignee');
      if (TASK_DATA.assignee_id && Array.isArray(MEMBERS)) {
        let member = MEMBERS.find((m) => m.username == TASK_DATA.assignee_id || m.id == TASK_DATA.assignee_id);
        assigneeInput.value = member ? member.username : '';
        assigneeHidden.value = member ? member.username : TASK_DATA.assignee_id;
      } else {
        assigneeInput.value = '';
        assigneeHidden.value = '';
      }
      assigneeInput.oninput = function () {
        let val = assigneeInput.value.toLowerCase();
        let list = MEMBERS.filter((m) => m && m.username && m.username.toLowerCase().includes(val));
        let ac = document.getElementById('edit_assignee_autocomplete');
        if (!val || list.length === 0) {
          ac.style.display = 'none';
          assigneeHidden.value = '';
          return;
        }
        ac.innerHTML = list
          .map((m) => `<div class='autocomplete-item' data-id='${m.username}'>${m.username}</div>`)
          .join('');
        ac.style.display = 'block';
        ac.querySelectorAll('.autocomplete-item').forEach((item) => {
          item.onclick = function () {
            assigneeInput.value = item.textContent;
            assigneeHidden.value = item.dataset.id;
            ac.style.display = 'none';
          };
        });
      };
      assigneeInput.onblur = function () {
        setTimeout(() => {
          document.getElementById('edit_assignee_autocomplete').style.display = 'none';
        }, 120);
      };
      // Quill
      createQuillEditor();
      window.editQuill.root.innerHTML = TASK_DATA.description || '';
      renderEditTags();
      document.getElementById('edit-modal').style.display = 'flex';
      document.getElementById('edit-error').innerText = '';
    }

    function closeEditModal() {
      document.getElementById('edit-modal').style.display = 'none';
      if (window.editQuill) window.editQuill = null;
      document.getElementById('edit_task_description_editor').innerHTML = '';
      // Сброс тегов
      document.querySelectorAll('#edit_tags_container .tag-badge').forEach(b => b.classList.remove('selected'));
      document.getElementById('edit-form').reset();
      document.getElementById('edit-error').innerText = '';
    }

    function renderEditTags() {
      const container = document.getElementById('edit_tags_container');
      const availableTags = [
        { tag: 'Срочно', class: 'tag-sos' },
        { tag: 'Баг', class: 'tag-bug' },
        { tag: 'Улучшение', class: 'tag-feature' },
        { tag: 'Обсудить', class: 'tag-discuss' },
        { tag: 'Документы', class: 'tag-docs' }
      ];
      const selected = TASK_DATA.tags || [];
      container.innerHTML = availableTags.map(t =>
        `<span class="tag-badge ${t.class}${selected.includes(t.tag) ? ' selected' : ''}" data-tag="${t.tag}">${t.tag}</span>`
      ).join('');
      container.querySelectorAll('.tag-badge').forEach(badge => {
        badge.onclick = function () {
          badge.classList.toggle('selected');
        };
      });
    }

    // ===================== Обработчики =====================
    document.getElementById('edit-task-btn').onclick = function () {
      window.location.href = `/${USERNAME}/team_task/${TASK_ID}/edit`;
    };

    document.getElementById('delete-task-btn').onclick = async function () {
      if (!confirm('Удалить задачу?')) return;

      try {
        const response = await fetch(`/${USERNAME}/api/teams/${TEAM_ID}/tasks/${TASK_ID}`, {
          method: 'DELETE',
          headers: getHeaders()
        });

        if (response.ok) {
          goBack();
        } else {
          if (window.toast) {
            window.toast.serverError();
          } else {
            alert('Ошибка удаления задачи');
          }
        }
      } catch (error) {
        if (window.toast) {
          window.toast.networkError();
        } else {
          alert('Ошибка удаления задачи');
        }
      }
    };

    document.getElementById('edit-form').onsubmit = async function (e) {
      e.preventDefault();
      const formData = {
        text: document.getElementById('edit_task_text').value.trim(),
        description: window.editQuill ? window.editQuill.root.innerHTML : '',
        status: document.getElementById('edit_task_status').value,
        assignee_id: document.getElementById('edit_task_assignee').value || null,
        due_date: document.getElementById('edit_task_due_date').value || null,
        tags: Array.from(document.querySelectorAll('#edit_tags_container .tag-badge.selected')).map(b => b.dataset.tag)
      };
      try {
        const response = await fetch(`/${USERNAME}/api/teams/${TEAM_ID}/tasks/${TASK_ID}`, {
          method: 'PATCH',
          headers: getHeaders(),
          body: JSON.stringify(formData)
        });
        if (response.ok) {
          closeEditModal();
          await loadTaskData();
        } else {
          const data = await response.json();
          document.getElementById('edit-error').innerText = data.error || 'Ошибка сохранения';
        }
      } catch (error) {
        document.getElementById('edit-error').innerText = 'Ошибка сохранения';
      }
    };

    // ===================== Комментарии =====================
    async function loadComments() {
      if (!TEAM_ID || !TASK_ID) return;
      const resp = await fetch(`/${USERNAME}/api/teams/${TEAM_ID}/tasks/${TASK_ID}/comments`, { headers: getHeaders() });
      const comments = await resp.json();
      renderComments(comments);
    }

    function renderComments(comments) {
      const list = document.getElementById('comments-list');
      if (!list) return;
      if (!comments || comments.length === 0) {
        list.innerHTML = '<div class="no-comments">Комментариев пока нет</div>';
        return;
      }
      list.innerHTML = comments.map(c => `
        <div class="comment-item">
          <div class="comment-avatar">
            ${c.avatar_url ? `<img src="${c.avatar_url}" alt="${c.author}" />` : `<span class="avatar-initial">${(c.author || '?')[0].toUpperCase()}</span>`}
          </div>
          <div class="comment-body">
            <div class="comment-meta">
              <span class="comment-author">${escapeHTML(c.author)}</span>
              <span class="comment-date">${formatDateTime(c.created_at)}</span>
              ${c.author === USERNAME ? `<button class="comment-delete-btn" data-comment-id="${c.id}" title="Удалить"><span class="material-icons">delete</span></button>` : ''}
            </div>
            <div class="comment-text">${highlightMentions(escapeHTML(c.text), c.mentions)}</div>
          </div>
        </div>
      `).join('');
      // Обработчик удаления
      list.querySelectorAll('.comment-delete-btn').forEach(btn => {
        btn.onclick = async function () {
          if (!confirm('Удалить комментарий?')) return;
          const commentId = btn.getAttribute('data-comment-id');
          await fetch(`/${USERNAME}/api/teams/${TEAM_ID}/tasks/${TASK_ID}/comments/${commentId}`, {
            method: 'DELETE',
            headers: getHeaders()
          });
          await loadComments();
        };
      });
    }

    function highlightMentions(text, mentions) {
      if (!mentions || !Array.isArray(mentions) || mentions.length === 0) return text;
      let res = text;
      mentions.forEach(m => {
        res = res.replace(new RegExp(`@${m}`, 'g'), `<span class='mention'>@${m}</span>`);
      });
      return res;
    }

    // ======= Автодополнение по @ =======
    const commentInput = document.getElementById('comment-input');
    const mentionBox = document.getElementById('mention-autocomplete');
    let mentionActive = false;
    let mentionStart = -1;
    if (commentInput) {
      commentInput.addEventListener('input', function (e) {
        const val = commentInput.value;
        const pos = commentInput.selectionStart;
        const atIdx = val.lastIndexOf('@', pos - 1);
        if (atIdx !== -1 && (atIdx === 0 || /[\s.,;:!?()\[\]{}]/.test(val[atIdx - 1] || ''))) {
          const query = val.slice(atIdx + 1, pos).toLowerCase();
          const filtered = MEMBERS.filter(m => m.username.toLowerCase().startsWith(query));
          if (filtered.length > 0 && query.length >= 0) {
            mentionBox.innerHTML = filtered.map(m => `<div class='mention-item' data-username='${m.username}'>@${m.username}</div>`).join('');
            mentionBox.style.display = 'block';
            mentionActive = true;
            mentionStart = atIdx;
            Array.from(mentionBox.children).forEach(item => {
              item.onclick = function () {
                const before = val.slice(0, mentionStart);
                const after = val.slice(pos);
                commentInput.value = before + '@' + item.dataset.username + ' ' + after;
                mentionBox.style.display = 'none';
                commentInput.focus();
                mentionActive = false;
              };
            });
            return;
          }
        }
        mentionBox.style.display = 'none';
        mentionActive = false;
      });
      commentInput.addEventListener('blur', function () {
        setTimeout(() => mentionBox.style.display = 'none', 120);
      });
    }

    // ======= Отправка комментария =======
    const commentForm = document.getElementById('comment-form');
    if (commentForm) {
      commentForm.onsubmit = async function (e) {
        e.preventDefault();
        const text = commentInput.value.trim();
        if (!text) return;
        // Собираем упоминания
        const mentionMatches = Array.from(text.matchAll(/@([a-zA-Z0-9_]+)/g)).map(m => m[1]);
        const mentions = MEMBERS.filter(m => mentionMatches.includes(m.username)).map(m => m.username);
        const resp = await fetch(`/${USERNAME}/api/teams/${TEAM_ID}/tasks/${TASK_ID}/comments`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({ text, mentions })
        });
        if (resp.ok) {
          commentInput.value = '';
          await loadComments();
        }
      };
    }

    // ======= Инициализация загрузки комментариев =======
    document.addEventListener('DOMContentLoaded', function () {
      setTimeout(loadComments, 400); // после загрузки задачи
    });

    // ===================== Профиль =====================
    // Удаляем обращение к несуществующему profile-btn
    // document.getElementById('profile-btn').onclick = async function() {
    //   userDropdown.classList.remove("show");
    //   try {
    //     const response = await fetch(`/api/profile/${USERNAME}`);
    //     const data = await response.json();

    //     document.getElementById('profile-username').innerHTML = `<span>${data.username}</span>`;
    //     document.getElementById('profile-email').textContent = data.email || "-";
    //     document.getElementById('profile-country').textContent = data.country || "-";
    //     document.getElementById('profile-fullname').textContent = data.fullname || "-";

    //     document.getElementById('profile-modal').style.display = 'flex';
    //   } catch (error) {
    //     console.error('Ошибка загрузки профиля:', error);
    //   }
    // };

    // document.getElementById('change-password-btn').onclick = function() {
    //   userDropdown.classList.remove("show");
    //   document.getElementById('change-password-modal').style.display = 'flex';
    //   document.getElementById('change-password-error').innerText = '';
    // };

    // ===================== Смена пароля =====================
    // Удаляем обращение к несуществующему change-password-btn
    // document.getElementById('change-password-btn').onclick = function() {
    //   userDropdown.classList.remove("show");
    //   document.getElementById('change-password-modal').style.display = 'flex';
    //   document.getElementById('change-password-error').innerText = '';
    // };

    document.getElementById('change-password-form').onsubmit = async function (e) {
      e.preventDefault();

      const oldPass = document.getElementById('old_password').value;
      const newPass = document.getElementById('new_password').value;
      const newPass2 = document.getElementById('new_password2').value;
      const errorEl = document.getElementById('change-password-error');

      if (newPass !== newPass2) {
        errorEl.innerText = "Пароли не совпадают!";
        return;
      }

      try {
        const response = await fetch(`/${USERNAME}/api/change_password`, {
          method: 'POST',
          headers: getHeaders(),
          body: JSON.stringify({
            old_password: oldPass,
            new_password: newPass
          })
        });

        if (response.ok) {
          errorEl.style.color = "#32c964";
          errorEl.innerText = "Пароль изменён!";
          setTimeout(closeChangePasswordModal, 900);
        } else {
          const data = await response.json();
          errorEl.style.color = "#d11a2a";
          errorEl.innerText = data.error || "Ошибка смены пароля!";
        }
      } catch (error) {
        errorEl.style.color = "#d11a2a";
        errorEl.innerText = "Ошибка смены пароля!";
      }
    };

    // ===================== Утилиты =====================
    function escapeHTML(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleDateString('ru-RU');
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr);
      return date.toLocaleString('ru-RU');
    }

    function getStatusTitle(statusCode) {
      const status = STATUSES.find(s => s.code === statusCode);
      return status ? status.title : statusCode;
    }

    function goBack() {
      if (TEAM_ID) {
        window.location.href = `/${USERNAME}/team?team_id=${TEAM_ID}`;
      } else {
        window.location.href = `/${USERNAME}/team`;
      }
    }

    function closeProfileModal() {
      document.getElementById('profile-modal').style.display = 'none';
    }

    function closeChangePasswordModal() {
      document.getElementById('change-password-modal').style.display = 'none';
      document.getElementById('change-password-form').reset();
    }

    // ===================== Инициализация =====================
    document.addEventListener('DOMContentLoaded', async function () {
      await loadTaskData();
    });

    // Закрытие модалок по клику вне окна
    document.getElementById('edit-modal').onclick = function (e) {
      if (e.target === this) closeEditModal();
    };
    document.getElementById('profile-modal').onclick = function (e) {
      if (e.target === this) closeProfileModal();
    };
    document.getElementById('change-password-modal').onclick = function (e) {
      if (e.target === this) closeChangePasswordModal();
    };

    // JS: красивые теги в просмотре задачи
    function renderTags(tags) {
      if (!tags || !tags.length) return "";
      return `<div class='task-view-tags'>` + tags.map(tag => `<span class='task-tag tag-${tag.toLowerCase()}'>${escapeHTML(tag)}</span>`).join("") + `</div>`;
    }

    // JS: закрытие модалки по крестику и клику вне окна
    function bindModalCloseHandlers() {
      document.querySelectorAll(".modal-close").forEach((btn) => {
        btn.onclick = function (e) {
          const modal = btn.closest(".modal-backdrop");
          if (modal) modal.style.display = "none";
        };
      });
      document.querySelectorAll(".modal-backdrop").forEach((backdrop) => {
        backdrop.onclick = function (e) {
          if (e.target === this) this.style.display = "none";
        };
      });
    }
    bindModalCloseHandlers();

    // Функция обновления аватарки в профиле
    function updateProfileAvatar(avatarUrl) {
      const avatarImg = document.getElementById("profile-avatar-img");
      const avatarInitial = document.getElementById("profile-avatar-initial");
      const deleteBtn = document.getElementById("delete-avatar-btn");

      if (avatarUrl) {
        // Показываем изображение
        avatarImg.src = avatarUrl;
        avatarImg.style.display = "block";
        avatarInitial.style.display = "none";
        deleteBtn.style.display = "inline-flex";
      } else {
        // Показываем инициал
        avatarImg.style.display = "none";
        avatarInitial.style.display = "block";
        deleteBtn.style.display = "none";
      }
    }

    // Обработчик загрузки аватарки
    const avatarUpload = document.getElementById("avatar-upload");
    if (avatarUpload) {
      avatarUpload.onchange = async function (e) {
        const file = e.target.files[0];
        if (!file) return;

        // Проверяем размер файла (максимум 5MB)
        if (file.size > 5 * 1024 * 1024) {
          if (window.toast) {
            window.toast.avatarSizeError();
          } else {
            alert("Файл слишком большой. Максимальный размер: 5MB");
          }
          return;
        }

        const formData = new FormData();
        formData.append("avatar", file);

        try {
          const response = await fetch(`/${USERNAME}/api/upload_avatar`, {
            method: "POST",
            headers: getHeaders(null), // Не добавляем Content-Type для FormData
            body: formData,
          });

          const data = await response.json();

          if (response.ok && data.success) {
            // Обновляем аватарку
            updateProfileAvatar(data.avatar_url);
            if (window.toast) {
              window.toast.avatarUploaded();
            } else {
              alert("Аватарка успешно загружена!");
            }
          } else {
            if (window.toast) {
              window.toast.avatarUploadError(data.error);
            } else {
              alert(data.error || "Ошибка загрузки аватарки");
            }
          }
        } catch (error) {
          if (window.toast) {
            window.toast.avatarUploadError("Ошибка загрузки аватарки");
          } else {
            alert("Ошибка загрузки аватарки");
          }
        }
      };
    }

    // Обработчик удаления аватарки
    const deleteAvatarBtn = document.getElementById("delete-avatar-btn");
    if (deleteAvatarBtn) {
      deleteAvatarBtn.onclick = async function () {
        if (!confirm("Удалить аватарку?")) return;

        try {
          const response = await fetch(`/${USERNAME}/api/delete_avatar`, {
            method: "POST",
            headers: getHeaders(),
          });

          const data = await response.json();

          if (response.ok && data.success) {
            // Обновляем аватарку
            updateProfileAvatar(null);
            if (window.toast) {
              window.toast.avatarDeleted();
            } else {
              alert("Аватарка удалена!");
            }
          } else {
            if (window.toast) {
              window.toast.avatarDeleteError(data.error);
            } else {
              alert(data.error || "Ошибка удаления аватарки");
            }
          }
        } catch (error) {
          if (window.toast) {
            window.toast.avatarDeleteError("Ошибка удаления аватарки");
          } else {
            alert("Ошибка удаления аватарки");
          }
        }
      };
    }

    // Загружаем аватарку при открытии профиля
    async function loadProfileData() {
      try {
        const response = await fetch(`/api/profile/${USERNAME}`, { headers: getHeaders() });
        const data = await response.json();

        // Обновляем данные профиля
        document.getElementById('profile-username').innerHTML = `<span>${data.username}</span>`;
        document.getElementById('profile-email').textContent = data.email || "-";
        document.getElementById('profile-country').textContent = data.country || "-";
        document.getElementById('profile-fullname').textContent = data.fullname || "-";

        // Обновляем аватарку
        updateProfileAvatar(data.avatar_url);
      } catch (error) {
      }
    }

    // Функция открытия профиля
    function openProfileModal() {
      document.getElementById('profile-modal').style.display = 'flex';
      loadProfileData();
    }
  </script>
</body>

</html>