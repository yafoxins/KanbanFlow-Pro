<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8" />
  <title>Team Kanban — {{ username }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <script src="{{ url_for('static', filename='js/sortable.min.js') }}"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/simplebar.min.css') }}">
  <script src="{{ url_for('static', filename='js/simplebar.min.js') }}"></script>
  <!-- Quill.js -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quill.snow.css') }}">
  <script src="{{ url_for('static', filename='js/quill.min.js') }}"></script>
  <link href="{{ url_for('static', filename='style.css') }}?v=6" rel="stylesheet" />

  <!-- CSRF Token -->
  <script>
    const CSRF_TOKEN = '{{ csrf_token }}';

    // Функция для добавления CSRF-токена в заголовки
    function getHeaders(contentType = 'application/json') {
      const headers = {
        'X-CSRF-Token': CSRF_TOKEN
      };
      if (contentType) {
        headers['Content-Type'] = contentType;
      }
      return headers;
    }
  </script>
  <script src="/static/countries.js"></script>
  <script src="{{ url_for('static', filename='js/team_board.js') }}?v=4"></script>
</head>

<body>
  <!-- Удаляю старый navbar и делаю современный topbar -->
  <header class="topbar">
    <div class="topbar-inner">
      <button class="back-btn" onclick="window.location.href='/{{ username }}/kanban'">
        <span class="material-icons">arrow_back</span>
      </button>
      <div class="topbar-left">
        <span class="material-icons logo-icon">grid_view</span>
        <span class="logo-text">Team Kanban Board</span>
      </div>
      <div class="topbar-right">
        <div class="user-menu-wrap">
          <button id="user-menu-btn" class="user-menu-btn" type="button">
            <span class="material-icons">account_circle</span>
            <span class="user-menu-name">{{ username }}</span>
            <span class="material-icons">expand_more</span>
          </button>
          <div class="user-dropdown" id="user-dropdown">
            <button class="dropdown-item" id="profile-btn" type="button">
              <span class="material-icons">person</span>Профиль
            </button>
            <button class="dropdown-item" id="teams-btn" type="button">
              <span class="material-icons">groups</span>Команды
            </button>
            <button class="dropdown-item" id="about-btn" type="button">
              <span class="material-icons">info</span>О проекте
            </button>
            <button class="dropdown-item" id="change-password-btn" type="button">
              <span class="material-icons">lock</span>Сменить пароль
            </button>
            <button class="dropdown-item" id="logout-btn" type="button">
              <span class="material-icons">logout</span>Выйти
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Основной контент -->
  <div class="kanban-container">
    <div class="container">
      <!-- Новый блок с названием команды и описанием -->
      <!-- Сообщение об ошибке -->
      <div id="no-team-id" class="d-none" style="
            max-width: 480px;
            margin: 60px auto 0 auto;
            padding: var(--spacing-2xl);
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
          ">
        <span class="material-icons"
          style="font-size: 3em; color: var(--primary-color); margin-bottom: var(--spacing-md)">error_outline</span>
        <div style="font-size: 1.25em; font-weight: 700; margin-bottom: var(--spacing-md); color: var(--text-primary)">
          Не выбран ID команды
        </div>
        <div style="color: var(--text-secondary); margin-bottom: var(--spacing-lg)">
          Пожалуйста, выберите команду из списка или вернитесь на главную страницу.
        </div>
        <button onclick="window.location.href='/'" class="btn btn-primary">
          <span class="material-icons">home</span>На главную
        </button>
      </div>

      <!-- Заголовок доски -->
      <div class="kanban-header" id="main-board">
        <div style="display:flex;align-items:center;gap:18px;margin-bottom:8px;">
          <h1 class="kanban-title" style="margin-bottom:0;">Командная доска</h1>
          <span class="team-badge"
            style="display:inline-flex;align-items:center;gap:7px;padding:0.32em 1.1em 0.32em 0.8em;font-size:1.08em;font-weight:700;background:linear-gradient(90deg,#7b5cff,#5271ff 80%);color:#fff;border-radius:2em;box-shadow:0 2px 12px #7b5cff22;letter-spacing:0.01em;">
            <span class="material-icons" style="font-size:1.1em;opacity:0.85;margin-right:2px;">groups</span>
            {{ team_name }}
          </span>
        </div>
        <p class="kanban-subtitle">Управляйте задачами команды {{ team_name or '...' }}</p>
        <div class="d-flex gap-3">
          <button class="btn btn-primary" id="open-task-modal">
            <span class="material-icons">add</span>
            Новая задача
          </button>
          <button class="btn btn-secondary" id="open-status-modal">
            <span class="material-icons">add_circle</span>
            Новый статус
          </button>
        </div>
      </div>

      <!-- Kanban доска -->
      <div class="kanban-board" id="kanban-board">
        <!-- Колонки будут добавлены через JavaScript -->
      </div>
    </div>
  </div>

  <!-- Модалка: профиль пользователя -->
  <div class="modal" id="profile-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Профиль пользователя</h2>
        <button class="modal-close" onclick="closeProfileModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="profile-card modern-profile-card">
        <div class="profile-avatar" id="profile-avatar-container">
          <img id="profile-avatar-img" class="profile-avatar-img" />
          <span class="profile-avatar-initial" id="profile-avatar-initial">{{ username[0]|upper }}</span>
        </div>
        <div class="profile-username" id="profile-username"></div>
        <button class="btn btn-secondary profile-edit-btn" id="edit-profile-btn">
          <span class="material-icons">edit</span>Редактировать профиль
        </button>
        <div class="profile-avatar-actions">
          <label for="avatar-upload" class="btn btn-secondary">
            <span class="material-icons">photo_camera</span>
            Загрузить аватарку
          </label>
          <input type="file" id="avatar-upload" accept="image/*" />
          <button class="btn btn-danger" id="delete-avatar-btn">
            <span class="material-icons">delete</span>
            Удалить
          </button>
        </div>
        <form class="profile-form" id="profile-form" autocomplete="off">
          <div class="profile-fields">
            <div class="profile-field">
              <span class="profile-label">E-mail:</span>
              <span class="profile-value" id="profile-email"></span>
              <input type="email" id="profile-email-input" class="profile-input" disabled placeholder="Введите email" />
            </div>
            <div class="profile-field">
              <span class="profile-label">Страна:</span>
              <span class="profile-value" id="profile-country"></span>
              <select id="profile-country-select" class="profile-input custom-select" disabled></select>
            </div>
            <div class="profile-field">
              <span class="profile-label">Имя:</span>
              <span class="profile-value" id="profile-fullname"></span>
              <input type="text" id="profile-fullname-input" class="profile-input" disabled
                placeholder="Введите полное имя" />
            </div>
          </div>
          <div class="profile-actions d-flex gap-3 justify-center">
            <button type="button" class="btn btn-secondary" id="cancel-profile-btn">
              <span class="material-icons">close</span>Отмена
            </button>
            <button type="submit" class="btn btn-primary" id="save-profile-btn">
              <span class="material-icons">save</span>Сохранить
            </button>
          </div>
          <div id="profile-error" class="modal-error"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Модалка: смена пароля -->
  <div class="modal" id="change-password-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="material-icons">lock_reset</span>
          Смена пароля
        </h2>
        <button class="modal-close" onclick="closeChangePasswordModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="password-change-content">
        <div class="password-change-icon">
          <span class="material-icons">security</span>
        </div>
        <p class="password-change-description">
          Введите текущий пароль и новый пароль для обновления безопасности вашего аккаунта
        </p>
        <form class="modal-form" id="change-password-form" autocomplete="off">
          <div class="form-group">
            <label for="old_password" class="form-label">
              <span class="material-icons">lock</span>
              Текущий пароль
            </label>
            <input type="password" id="old_password" class="form-control" placeholder="Введите текущий пароль"
              required />
          </div>
          <div class="form-group">
            <label for="new_password" class="form-label">
              <span class="material-icons">lock_open</span>
              Новый пароль
            </label>
            <input type="password" id="new_password" class="form-control" placeholder="Введите новый пароль" required />
          </div>
          <div class="form-group">
            <label for="new_password2" class="form-label">
              <span class="material-icons">verified</span>
              Подтвердите новый пароль
            </label>
            <input type="password" id="new_password2" class="form-control" placeholder="Повторите новый пароль"
              required />
          </div>
          <div class="d-flex gap-3">
            <button type="button" class="btn btn-secondary" onclick="closeChangePasswordModal()">
              <span class="material-icons">close</span>Отмена
            </button>
            <button type="submit" class="btn btn-primary" id="change-password-submit">
              <span class="material-icons">sync_lock</span>Обновить пароль
            </button>
          </div>
          <div id="change-password-error" class="modal-error"></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Модалка: список команд -->
  <div class="modal" id="teams-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="material-icons">groups</span>
          Мои команды
        </h2>
        <button class="modal-close" onclick="closeTeamsModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <button id="open-create-team-modal" class="btn btn-primary mb-4">
        <span class="material-icons">add</span>Создать команду
      </button>
      <div id="teams-list" class="teams-list"></div>
    </div>
  </div>

  <!-- Модалка: создать команду -->
  <div class="modal" id="create-team-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Создать команду</h2>
        <button class="modal-close" onclick="closeCreateTeamModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <form class="modal-form" id="create-team-form" autocomplete="off">
        <div class="form-group">
          <label for="team-name-input" class="form-label">Название команды</label>
          <input type="text" id="team-name-input" class="form-control" placeholder="Название команды" maxlength="40"
            required />
        </div>
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">add</span>Создать
        </button>
        <div id="create-team-error" class="modal-error"></div>
      </form>
    </div>
  </div>

  <!-- Модалка: редактировать команду -->
  <div class="modal" id="edit-team-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="material-icons">groups</span>
          Редактировать команду
        </h2>
        <button class="modal-close" onclick="closeEditTeamModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <form class="modal-form" id="edit-team-form" autocomplete="off">
        <div class="form-group">
          <label for="edit-team-name" class="form-label">
            <span class="material-icons">edit</span>
            Название команды
          </label>
          <input type="text" id="edit-team-name" class="form-control" placeholder="Название команды" maxlength="40"
            required />
        </div>
        <div class="form-group">
          <label class="form-label">
            <span class="material-icons">group</span>
            Участники команды
          </label>
          <div class="edit-team-members" id="edit-team-members"></div>
        </div>
        <div class="form-group">
          <label for="add-member-input" class="form-label">Добавить участника</label>
          <input type="text" id="add-member-input" class="form-control" placeholder="Добавить участника по username"
            maxlength="32" autocomplete="off" />
        </div>
        <button type="button" class="btn btn-secondary mb-3" id="add-member-btn">
          <span class="material-icons">person_add</span>Добавить участника
        </button>
        <div class="d-flex gap-3">
          <button type="submit" class="btn">
            <span class="material-icons">save</span>Сохранить
          </button>
          <button type="button" class="btn btn-danger" id="delete-team-btn">
            <span class="material-icons">delete</span>Удалить
          </button>
        </div>
        <div id="edit-team-error" class="modal-error"></div>
      </form>
    </div>
  </div>

  <!-- Модалка: задача -->
  <div class="modal" id="task-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="task-modal-title">Новая задача</h2>
        <button class="modal-close" onclick="closeTaskModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <form class="modal-form" id="task-modal-form" autocomplete="off">
        <input type="hidden" name="edit_task_id" id="edit_task_id" />
        <div class="form-group">
          <label for="task_text" class="form-label">
            <span class="material-icons">title</span> Название задачи
          </label>
          <input type="text" name="task_text" id="task_text" class="form-control" placeholder="Название задачи" required
            maxlength="80" />
        </div>
        <div class="form-group">
          <label for="task_description_editor" class="form-label">
            <span class="material-icons">description</span> Описание
          </label>
          <div id="task_description_editor" style="height: 200px"></div>
        </div>
        <div class="form-group">
          <label for="task_status" class="form-label">
            <span class="material-icons">flag</span> Статус
          </label>
          <select name="task_status" id="task_status" class="form-control" required>
            <!-- Статусы будут добавлены через JavaScript -->
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">
            <span class="material-icons">label</span> Теги
          </label>
          <div class="task-tags-select">
            <span class="tag-badge tag-sos" data-tag="Срочно">Срочно<span
                class="checkmark material-icons">check</span></span>
            <span class="tag-badge tag-bug" data-tag="Баг">Баг<span class="checkmark material-icons">check</span></span>
            <span class="tag-badge tag-feature" data-tag="Улучшение">Улучшение<span
                class="checkmark material-icons">check</span></span>
            <span class="tag-badge tag-discuss" data-tag="Обсудить">Обсудить<span
                class="checkmark material-icons">check</span></span>
            <span class="tag-badge tag-docs" data-tag="Документы">Документы<span
                class="checkmark material-icons">check</span></span>
          </div>
        </div>
        <div class="form-group">
          <label for="task_due_date" class="form-label">
            <span class="material-icons">event</span> Срок выполнения
          </label>
          <input type="date" id="task_due_date" name="task_due_date" class="form-control" />
        </div>
        <div class="form-group">
          <label for="task_assignee_input" class="form-label">
            <span class="material-icons">person</span> Исполнитель
          </label>
          <div class="input-group">
            <input type="text" id="task_assignee_input" class="form-control" placeholder="Исполнитель (ник)"
              autocomplete="off" />
            <input type="hidden" id="task_assignee" name="task_assignee" />
            <div id="assignee-autocomplete" class="autocomplete-list" style="display: none"></div>
          </div>
        </div>
        <div id="task-modal-error" class="modal-error"></div>
        <div class="d-flex gap-3">
          <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">
            <span class="material-icons">close</span>Отмена
          </button>
          <button type="submit" class="btn btn-primary" id="task-modal-submit-btn">
            <span class="material-icons">done</span>Сохранить
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Модалка: статус -->
  <div class="modal" id="status-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Добавить новый статус</h2>
        <button class="modal-close" onclick="closeStatusModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <form class="modal-form" id="status-modal-form" autocomplete="off">
        <div class="form-group">
          <label for="new_status_title" class="form-label">Название статуса</label>
          <input type="text" name="new_status_title" id="new_status_title" class="form-control"
            placeholder="Название статуса" maxlength="32" required />
        </div>
        <button type="submit" class="btn btn-primary">
          <span class="material-icons">add</span>Добавить статус
        </button>
        <div id="status-modal-error" class="modal-error"></div>
      </form>
    </div>
  </div>

  <!-- Модалка просмотра задачи -->
  <div class="modal" id="view-task-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="view-task-title">Задача</h2>
        <button class="modal-close" onclick="closeViewTaskModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div id="view-task-content">
        <!-- Контент будет загружен через JavaScript -->
      </div>
      <button class="btn btn-primary" id="view-task-edit-btn">
        <span class="material-icons">edit</span>Редактировать
      </button>
    </div>
  </div>

  <!-- Модалка: О проекте -->
  <div class="modal" id="about-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">
          <span class="material-icons">info</span>
          О проекте
        </h2>
        <button class="modal-close" onclick="closeAboutModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="about-content">
        <div class="about-project">
          <h3 class="about-subtitle">Kanban Board</h3>
          <p class="about-description">
            Современная система управления задачами, построенная на Flask с использованием
            современных веб-технологий. Проект включает в себя Kanban-доску, ToDo-лист,
            систему команд и real-time обновления через WebSocket.
          </p>
          <div class="tech-stack">
            <h4>Технологии:</h4>
            <div class="tech-tags">
              <span class="tech-tag">Flask</span>
              <span class="tech-tag">Python</span>
              <span class="tech-tag">JavaScript</span>
              <span class="tech-tag">CSS3</span>
              <span class="tech-tag">WebSocket</span>
              <span class="tech-tag">Docker</span>
            </div>
          </div>
        </div>
        <div class="about-author">
          <h3 class="about-subtitle">Разработчик</h3>
          <div class="author-card">
            <div class="author-avatar">
              <img src="{{ url_for('static', filename='profile.jpg') }}" alt="Александр Тимков"
                class="author-avatar-img">
            </div>
            <div class="author-info">
              <h4 class="author-name">Александр Тимков</h4>
              <p class="author-title">DevOps Engineer</p>
              <p class="author-age">24 года, Россия, Санкт-Петербург</p>
            </div>
          </div>
          <div class="author-links">
            <a href="https://yafoxin.ru" class="author-link" target="_blank">
              <span class="material-icons">language</span>
              <span>Личный сайт</span>
            </a>
            <a href="https://t.me/yafoxin" class="author-link" target="_blank">
              <span class="material-icons">telegram</span>
              <span>Telegram</span>
            </a>
            <a href="https://github.com/yafoxins" class="author-link" target="_blank">
              <span class="material-icons">code</span>
              <span>GitHub</span>
            </a>
          </div>
        </div>
        <div class="about-footer">
          <p class="about-version">Версия 1.0.0</p>
          <p class="about-copyright">© 2025 Александр Тимков. Все права защищены.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // В самом начале:
    let TEAM_ID = null;
    let STATUSES = [];
    let TASKS = [];
    let MEMBERS = [];
    let TEAM_INFO = null;
    let USERNAME = "{{ username }}";
    let socket = null;
    let TEAMS = [];

    // ===================== Team ID =====================
    const urlParams = new URLSearchParams(window.location.search);
    TEAM_ID = urlParams.get("team_id") || null;

    if (!TEAM_ID) {
      document.getElementById("main-board").style.display = "none";
      document.getElementById("no-team-id").style.display = "block";
    } else {
      // ===================== Socket.IO =====================
      socket = io();
      socket.emit("join_team", { team_id: TEAM_ID });
      socket.on("team_task_added", (task) => {
        TASKS.push(task);
        renderBoard();
      });
      socket.on("team_task_updated", (task) => {
        let idx = TASKS.findIndex((t) => t.id === task.id);
        if (idx !== -1) TASKS[idx] = task;
        renderBoard();
      });
      socket.on("team_task_deleted", (data) => {
        TASKS = TASKS.filter((t) => t.id !== data.id);
        renderBoard();
      });
      socket.on("team_tasks_reordered", (data) => {
        if (data.team_id == TEAM_ID) fetchTeamBoard();
      });
      // ===================== Socket.IO: статусы =====================
      if (socket) {
        socket.on("team_status_added", (data) => {
          if (data.team_id == TEAM_ID) fetchTeamBoard();
        });
        socket.on("team_status_deleted", (data) => {
          if (data.team_id == TEAM_ID) fetchTeamBoard();
        });
      }

      // Гарантированная загрузка доски после инициализации
      fetchTeamBoard();
    }

    // ========== User Dropdown ==========
    const userMenuBtn = document.getElementById("user-menu-btn");
    const userDropdown = document.getElementById("user-dropdown");
    if (userMenuBtn && userDropdown) {
      userMenuBtn.onclick = function (e) {
        e.stopPropagation();
        userDropdown.classList.toggle("open");
      };
      document.body.addEventListener("click", function () {
        userDropdown.classList.remove("open");
      });
      userDropdown.onclick = function (e) {
        e.stopPropagation();
      };
    }

    // ========== Профиль ==========
    const profileBtn = document.getElementById("profile-btn");
    if (profileBtn) {
      profileBtn.onclick = async function () {
        userDropdown.classList.remove("show");
        try {
          let r = await fetch(`/api/profile/${USERNAME}`, { headers: getHeaders() });
          let data = await r.json();
          document.getElementById("profile-username").innerHTML = `<span>${data.username}</span>`;
          updateProfileAvatar(data.avatar_url);
          resetProfileEditFields(data);
          const profileModal = document.getElementById("profile-modal");
          if (profileModal) {
            profileModal.classList.add("show");
          }
        } catch (error) {
          console.error("Error fetching profile:", error);
        }
      };
    }

    // Инициализация профиля из team_board.js
    if (typeof initProfileModal === 'function') {
      initProfileModal();
    }

    // Функция обновления аватарки в профиле
    function updateProfileAvatar(avatarUrl) {
      const avatarImg = document.getElementById("profile-avatar-img");
      const avatarInitial = document.getElementById("profile-avatar-initial");
      const deleteBtn = document.getElementById("delete-avatar-btn");

      if (avatarUrl) {
        // Показываем изображение
        avatarImg.src = avatarUrl;
        avatarImg.style.display = "block";
        avatarInitial.style.display = "none";
        deleteBtn.style.display = "inline-flex";
      } else {
        // Показываем инициал
        avatarImg.style.display = "none";
        avatarInitial.style.display = "block";
        deleteBtn.style.display = "none";
      }
    }

    // Обработчик загрузки аватарки
    const avatarUpload = document.getElementById("avatar-upload");
    if (avatarUpload) {
      avatarUpload.onchange = async function (e) {
        const file = e.target.files[0];
        if (!file) return;

        // Проверяем размер файла (максимум 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert("Файл слишком большой. Максимальный размер: 5MB");
          return;
        }

        const formData = new FormData();
        formData.append("avatar", file);

        try {
          const response = await fetch(`/${USERNAME}/api/upload_avatar`, {
            method: "POST",
            headers: getHeaders(null), // Не добавляем Content-Type для FormData
            body: formData,
          });

          const data = await response.json();

          if (response.ok && data.success) {
            // Обновляем аватарку
            updateProfileAvatar(data.avatar_url);
            // Обновляем аватарку в topbar
            updateTopbarAvatar(data.avatar_url);
            alert("Аватарка успешно загружена!");
          } else {
            alert(data.error || "Ошибка загрузки аватарки");
          }
        } catch (error) {
          console.error("Error uploading avatar:", error);
          alert("Ошибка загрузки аватарки");
        }
      };
    }

    // Обработчик удаления аватарки
    const deleteAvatarBtn = document.getElementById("delete-avatar-btn");
    if (deleteAvatarBtn) {
      deleteAvatarBtn.onclick = async function () {
        if (!confirm("Удалить аватарку?")) return;

        try {
          const response = await fetch(`/${USERNAME}/api/delete_avatar`, {
            method: "POST",
            headers: getHeaders(),
          });

          const data = await response.json();

          if (response.ok && data.success) {
            // Обновляем аватарку
            updateProfileAvatar(null);
            // Обновляем аватарку в topbar
            updateTopbarAvatar(null);
            alert("Аватарка удалена!");
          } else {
            alert(data.error || "Ошибка удаления аватарки");
          }
        } catch (error) {
          console.error("Error deleting avatar:", error);
          alert("Ошибка удаления аватарки");
        }
      };
    }

    // Функция обновления аватарки в topbar
    function updateTopbarAvatar(avatarUrl) {
      const userMenuBtn = document.getElementById("user-menu-btn");
      if (userMenuBtn) {
        const avatarSpan = userMenuBtn.querySelector(".material-icons");
        if (avatarUrl) {
          // Создаем изображение аватарки
          avatarSpan.style.display = "none";
          let avatarImg = userMenuBtn.querySelector(".user-avatar-img");
          if (!avatarImg) {
            avatarImg = document.createElement("img");
            avatarImg.className = "user-avatar-img";
            avatarImg.style.cssText = "width: 24px; height: 24px; border-radius: 50%; object-fit: cover; margin-right: 8px;";
            userMenuBtn.insertBefore(avatarImg, avatarSpan);
          }
          avatarImg.src = avatarUrl;
          avatarImg.style.display = "block";
        } else {
          // Показываем иконку по умолчанию
          avatarSpan.style.display = "inline-block";
          const avatarImg = userMenuBtn.querySelector(".user-avatar-img");
          if (avatarImg) {
            avatarImg.style.display = "none";
          }
        }
      }
    }

    // Загружаем аватарку при загрузке страницы
    async function loadUserAvatar() {
      try {
        const response = await fetch(`/api/avatar/${USERNAME}`, { headers: getHeaders() });
        const data = await response.json();
        if (data.avatar_url) {
          updateTopbarAvatar(data.avatar_url);
        }
      } catch (error) {
        console.error("Error loading avatar:", error);
      }
    }

    // Вызываем загрузку аватарки при инициализации
    loadUserAvatar();

    function getAvatarColor(id) {
      const colors = [
        "#5271ff",
        "#ff9800",
        "#ff5470",
        "#00b894",
        "#a29bfe",
        "#00bcd4",
      ];
      if (!id) return colors[0];
      let sum = 0;
      for (let i = 0; i < id.length; ++i) sum += id.charCodeAt(i);
      return colors[sum % colors.length];
    }

    function getInitials(name) {
      if (!name) return "?";
      return name[0].toUpperCase();
    }

    function closeProfileModal() {
      const profileModal = document.getElementById("profile-modal");
      if (profileModal) {
        profileModal.classList.remove("show");
      }
    }

    function resetProfileEditFields(data) {
      fields.forEach(f => {
        const input = document.getElementById(`profile-${f}-input`);
        const value = document.getElementById(`profile-${f}`);
        if (input && value) {
          input.value = data[f] || '';
          value.textContent = data[f] || '';
        }
      });
    }

    // ========== Выход ==========
    const logoutBtn = document.getElementById("logout-btn");
    if (logoutBtn) {
      logoutBtn.onclick = function () {
        if (userDropdown) userDropdown.classList.remove("open");
        window.location.href = "/logout";
      };
    }

    // ========== Кнопка Мои команды ==========
    const teamsBtn = document.getElementById("teams-btn");
    if (teamsBtn) {
      teamsBtn.onclick = function () {
        if (userDropdown) userDropdown.classList.remove("open");
        const teamsModal = document.getElementById("teams-modal");
        if (teamsModal) {
          teamsModal.classList.add("show");
          fetchTeams();
        }
      };
    }
    const teamsModal = document.getElementById("teams-modal");
    function closeTeamsModal() {
      const modal = document.getElementById("teams-modal");
      if (modal) modal.classList.remove("show");
    }

    // ========== Смена пароля ==========
    const changePasswordBtn = document.getElementById("change-password-btn");
    if (changePasswordBtn) {
      changePasswordBtn.onclick = function () {
        if (userDropdown) userDropdown.classList.remove("open");
        const changePasswordForm = document.getElementById("change-password-form");
        const changePasswordError = document.getElementById("change-password-error");
        if (changePasswordForm) changePasswordForm.reset();
        if (changePasswordError) changePasswordError.innerText = "";
        const changePasswordModal = document.getElementById("change-password-modal");
        if (changePasswordModal) {
          changePasswordModal.classList.add("show");
        }
      };
    }
    function closeChangePasswordModal() {
      const changePasswordModal = document.getElementById("change-password-modal");
      if (changePasswordModal) {
        changePasswordModal.classList.remove("show");
      }
    }
    const changePasswordModal = document.getElementById(
      "change-password-modal"
    );

    const changePasswordForm = document.getElementById(
      "change-password-form"
    );
    if (changePasswordForm) {
      changePasswordForm.onsubmit = async function (e) {
        e.preventDefault();
        let oldPass = document.getElementById("old_password").value;
        let newPass = document.getElementById("new_password").value;
        let newPass2 = document.getElementById("new_password2").value;
        let err = document.getElementById("change-password-error");
        if (newPass !== newPass2) {
          err.innerText = "Пароли не совпадают!";
          return;
        }
        let resp = await fetch(`/{{ username }}/api/change_password`, {
          method: "POST",
          headers: getHeaders(),
          body: JSON.stringify({
            old_password: oldPass,
            new_password: newPass,
          }),
        });
        if (resp.ok) {
          err.style.color = "#32c964";
          err.innerText = "Пароль изменён!";
          setTimeout(closeChangePasswordModal, 900);
        } else {
          err.style.color = "#d11a2a";
          let data = await resp.json();
          err.innerText = data.error || "Ошибка смены пароля!";
        }
      };
    }

    // ========== О проекте ==========
    const aboutBtn = document.getElementById("about-btn");
    if (aboutBtn) {
      aboutBtn.onclick = function () {
        if (userDropdown) userDropdown.classList.remove("open");
        const aboutModal = document.getElementById("about-modal");
        if (aboutModal) {
          aboutModal.classList.add("show");
        }
      };
    }
    function closeAboutModal() {
      const aboutModal = document.getElementById("about-modal");
      if (aboutModal) {
        aboutModal.classList.remove("show");
      }
    }
    const aboutModal = document.getElementById("about-modal");

    // ========== Новая задача ==========
    const openTaskModalBtn = document.getElementById("open-task-modal");
    if (openTaskModalBtn) {
      openTaskModalBtn.onclick = function () {
        openTaskModal();
      };
    }

    // ========== Новый статус ==========
    const openStatusModalBtn = document.getElementById("open-status-modal");
    if (openStatusModalBtn) {
      openStatusModalBtn.onclick = function () {
        openStatusModal();
      };
    }

    // ========== Инициализация Quill.js ==========
    function initTaskEditor() {
      if (window.taskEditor) return;

      const editorElement = document.getElementById("task_description_editor");
      if (!editorElement) return;

      window.taskEditor = new Quill(editorElement, {
        theme: "snow",
        modules: {
          toolbar: [
            [{ header: [1, 2, false] }],
            ["bold", "italic", "underline"],
            ["link", "image"],
            [{ list: "ordered" }, { list: "bullet" }],
            ["clean"],
          ],
        },
        placeholder: "Описание задачи...",
      });

      // Кастомный image handler для загрузки на сервер
      const toolbar = window.taskEditor.getModule("toolbar");
      toolbar.addHandler("image", imageHandler);
    }

    // Кастомный image handler для загрузки на сервер
    function imageHandler() {
      const input = document.createElement("input");
      input.setAttribute("type", "file");
      input.setAttribute("accept", "image/*");
      input.click();
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append("image", file);
        try {
          const res = await fetch("/api/upload_image", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          if (data.url) {
            const range = window.taskEditor.getSelection();
            window.taskEditor.insertEmbed(range.index, "image", data.url);
          } else {
            alert("Ошибка загрузки изображения: " + (data.error || ""));
          }
        } catch (error) {
          alert("Ошибка загрузки изображения");
        }
      };
    }

    // ========== Обработчики тегов ==========
    function bindTagBadges() {
      document.querySelectorAll(".tag-badge").forEach((badge) => {
        badge.onclick = function () {
          this.classList.toggle("selected");
        };
      });
    }

    function getSelectedTags() {
      const selectedTags = [];
      document.querySelectorAll(".tag-badge.selected").forEach((badge) => {
        selectedTags.push(badge.dataset.tag);
      });
      return selectedTags;
    }

    // ===================== Modal: Task =====================
    function openTaskModal({
      edit = false,
      id = null,
      text = "",
      description = "",
      status = "",
      assignee_id = null,
      tags = [],
      due_date = null,
    } = {}) {
      const modal = document.getElementById("task-modal");
      if (!modal) return;
      document.getElementById("task-modal-title").innerText = edit
        ? "Редактировать задачу"
        : "Новая задача";
      document.getElementById("edit_task_id").value = id || "";
      document.getElementById("task_text").value = text || "";

      // Инициализируем Quill.js если ещё не инициализирован
      if (!window.taskEditor) {
        initTaskEditor();
      }

      // Устанавливаем содержимое редактора
      if (window.taskEditor) {
        window.taskEditor.root.innerHTML = description || "";
      }

      let statusSel = document.getElementById("task_status");
      statusSel.innerHTML = STATUSES.map(
        (s) =>
          `<option value="${s.code}"${(status || STATUSES[0].code) === s.code ? " selected" : ""
          }>${escapeHTML(s.title)}</option>`
      ).join("");

      // Теги
      let tagSet = new Set(tags || []);
      document.querySelectorAll(".tag-badge[data-tag]").forEach((badge) => {
        if (tagSet.has(badge.dataset.tag)) {
          badge.classList.add("selected");
        } else {
          badge.classList.remove("selected");
        }
      });

      document.getElementById("task_due_date").value = due_date
        ? due_date.slice(0, 10)
        : "";

      // Исполнитель
      let assigneeInput = document.getElementById("task_assignee_input");
      let assigneeHidden = document.getElementById("task_assignee");
      if (assignee_id && Array.isArray(MEMBERS)) {
        let member = MEMBERS.find(
          (m) => m.id == assignee_id || m.username == assignee_id
        );
        if (member) {
          assigneeInput.value = member.username;
          assigneeHidden.value = member.id;
        } else {
          assigneeInput.value = "";
          assigneeHidden.value = "";
        }
      } else {
        assigneeInput.value = "";
        assigneeHidden.value = "";
      }

      // Автодополнение исполнителя
      assigneeInput.oninput = function () {
        let val = assigneeInput.value.toLowerCase();
        let list = MEMBERS.filter(
          (m) => m && m.username && m.username.toLowerCase().includes(val)
        );
        let ac = document.getElementById("assignee-autocomplete");
        if (!val || list.length === 0) {
          ac.style.display = "none";
          assigneeHidden.value = "";
          return;
        }
        ac.innerHTML = list
          .map(
            (m) =>
              `<div class='autocomplete-item' data-id='${m.id}'>${m.username}</div>`
          )
          .join("");
        ac.style.display = "block";
        ac.querySelectorAll(".autocomplete-item").forEach((item) => {
          item.onclick = function () {
            assigneeInput.value = item.textContent;
            assigneeHidden.value = item.dataset.id;
            ac.style.display = "none";
          };
        });
      };

      assigneeInput.onblur = function () {
        setTimeout(() => {
          document.getElementById("assignee-autocomplete").style.display = "none";
        }, 120);
      };

      document.getElementById("task-modal-error").innerText = "";
      modal.classList.add("show");
      bindTagBadges();
      setTimeout(() => {
        document.getElementById("task_text").focus();
      }, 120);
    }

    // Обработчик отправки формы задачи
    const taskModalForm = document.getElementById("task-modal-form");
    if (taskModalForm) {
      taskModalForm.onsubmit = async function (e) {
        e.preventDefault();
        let text = this.task_text.value.trim();
        let description = window.taskEditor
          ? window.taskEditor.root.innerHTML
          : "";
        let status = this.task_status.value;
        let id = this.edit_task_id.value;
        let tags = getSelectedTags();
        let due_date = this.task_due_date.value || null;
        let assignee_id = this.task_assignee.value || null;
        if (assignee_id && isNaN(Number(assignee_id))) assignee_id = null;
        let method = id ? "PATCH" : "POST";
        let url =
          `/${USERNAME}/api/teams/${TEAM_ID}/tasks` + (id ? `/${id}` : "");
        let body = {
          text,
          description,
          status,
          tags,
          due_date,
          assignee_id,
        };
        let resp = await fetch(url, {
          method,
          headers: getHeaders(),
          body: JSON.stringify(body),
        });
        let data = null;
        try {
          data = await resp.json();
        } catch (e) {
          data = null;
        }
        if (resp.ok && data && (data.id || data.success)) {
          closeTaskModal();
          fetchTeamBoard();
        } else {
          let err = data && data.error ? data.error : "Ошибка сохранения!";
          document.getElementById("task-modal-error").innerText = err;
        }
      };
    }

    // Функция закрытия модалки задачи
    function closeTaskModal() {
      const modal = document.getElementById("task-modal");
      if (modal) modal.classList.remove("show");
      const form = document.getElementById("task-modal-form");
      if (form) form.reset();
      // Очищаем Quill.js редактор
      if (window.taskEditor) {
        window.taskEditor.root.innerHTML = "";
      }
      // Сбрасываем стили тегов
      document.querySelectorAll(".tag-badge").forEach((badge) => {
        badge.classList.remove("selected");
      });
    }

    // Обработчик закрытия модалки задачи по клику вне окна
    const taskModal = document.getElementById("task-modal");

    // ===================== Modal: Status =====================
    function openStatusModal() {
      const modal = document.getElementById("status-modal");
      if (!modal) return;
      modal.classList.add("show");
      document.getElementById("status-modal-error").innerText = "";
      document.getElementById("new_status_title").value = "";
      setTimeout(() => {
        document.getElementById("new_status_title").focus();
      }, 120);
    }
    function closeStatusModal() {
      const modal = document.getElementById("status-modal");
      if (modal) modal.classList.remove("show");
      const form = document.getElementById("status-modal-form");
      if (form) form.reset();
    }
    const statusModalForm = document.getElementById("status-modal-form");
    if (statusModalForm) {
      statusModalForm.onsubmit = async function (e) {
        e.preventDefault();
        let title = this.new_status_title.value.trim();
        if (!title) return;
        let code = "s" + Date.now();
        let resp = await fetch(
          `/{{ username }}/api/teams/${TEAM_ID}/statuses`,
          {
            method: "POST",
            headers: getHeaders(),
            body: JSON.stringify({ title, code }),
          }
        );
        if (resp.ok) {
          fetchTeamBoard();
          closeStatusModal();
        } else {
          document.getElementById("status-modal-error").innerText =
            "Ошибка создания статуса!";
        }
      };
    }
    const statusModal = document.getElementById("status-modal");

    // ===================== Modal: View Task =====================
    async function openViewTaskModal(task) {
      const modal = document.getElementById("view-task-modal");
      const title = document.getElementById("view-task-title");
      const content = document.getElementById("view-task-content");
      title.textContent = task.text;
      // Краткий просмотр с сохранением переносов строк
      let descriptionPreview = task.description || "Описание отсутствует";
      let hasImage = /<img\s/i.test(descriptionPreview);
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = descriptionPreview;
      let textPreview = tempDiv.textContent || tempDiv.innerText || "";
      // Проверка на длинный текст или переносы
      let needShowFull = textPreview.length > 200 || /\n/.test(textPreview);
      if (textPreview.length > 200)
        textPreview = textPreview.substring(0, 200) + "...";
      let imageNotice = hasImage
        ? `<div class='view-task-has-image'><span class='material-icons' style='vertical-align:middle;color:#5271ff;'>image</span> <span style='color:#5271ff;font-weight:500;'>Есть вложения</span></div>`
        : "";
      // Исполнитель
      let assigneeHtml = "";
      if (task.assignee_id) {
        let member = null;
        if (Array.isArray(MEMBERS)) {
          member = MEMBERS.find(
            (m) => m.username == task.assignee_id || m.id == task.assignee_id
          );
        }
        if (member) {
          assigneeHtml = `<div class="view-task-field">
              <span class="material-icons">person</span>
              <span><strong>Исполнитель:</strong> ${escapeHTML(
            member.username
          )}</span>
            </div>`;
        } else {
          assigneeHtml = `<div class="view-task-field">
              <span class="material-icons">person</span>
              <span><strong>Исполнитель:</strong> ${escapeHTML(
            task.assignee_id
          )}</span>
            </div>`;
        }
      } else if (task.assignee_name && task.assignee_name !== "null") {
        assigneeHtml = `<div class="view-task-field">
            <span class="material-icons">person</span>
            <span><strong>Исполнитель:</strong> ${escapeHTML(
          task.assignee_name
        )}</span>
          </div>`;
      }
      content.innerHTML = `
          <div class="view-task-section">
            <div class="view-task-field">
              <span class="material-icons">flag</span>
              <span><strong>Статус:</strong> ${getStatusTitle(
        task.status
      )}</span>
            </div>
            ${task.due_date
          ? `<div class="view-task-field"><span class="material-icons">event</span><span><strong>Срок:</strong> ${formatRuDate(
            task.due_date
          )}</span></div>`
          : ""
        }
            ${task.tags && task.tags.length > 0
          ? `<div class="view-task-field"><span class="material-icons">label</span><span><strong>Теги:</strong> ${task.tags
            .map(
              (tag) =>
                `<span class="task-tag tag-${tag.toLowerCase()}">${escapeHTML(
                  tag
                )}</span>`
            )
            .join(" ")}</span></div>`
          : ""
        }
            ${assigneeHtml}
            <div class="view-task-field"><span class="material-icons">description</span><span><strong>Описание:</strong></span></div>
            <div class="view-task-description-preview" style="white-space:pre-line;word-break:break-word;">${textPreview}${imageNotice}</div>
            ${needShowFull
          ? `<div class='view-task-more'><button class='view-full-task-btn plus-btn' data-task-id='${task.id}'><span class='material-icons'>open_in_new</span>Открыть полностью</button></div>`
          : ""
        }
            <div class="view-task-field"><span class="material-icons">person</span><span><strong>Обновлено:</strong> ${task.updated_by_name || "Неизвестно"
        }</span></div>
            <div class="view-task-field"><span class="material-icons">schedule</span><span><strong>Дата:</strong> ${formatDateTime(
          task.updated_at
        )}</span></div>
          </div>
        `;
      modal.classList.add("show");
      const editBtn = document.getElementById("view-task-edit-btn");
      if (editBtn) {
        editBtn.onclick = function () {
          openTaskModal({ edit: true, ...task });
          closeViewTaskModal();
        };
      }

      // Назначаем обработчик для кнопки "Открыть полностью"
      const viewFullBtn = document.querySelector(".view-full-task-btn");
      if (viewFullBtn) {
        viewFullBtn.onclick = function (e) {
          e.stopPropagation();
          openFullTaskView(task.id);
        };
      }

      bindViewFullTaskBtn();
    }

    function bindViewFullTaskBtn() {
      // Функция для назначения обработчиков кнопки "Открыть полностью"
      // Пока что оставляем пустой, так как обработчик уже назначен выше
    }

    function openFullTaskView(taskId) {
      window.location.href = `/${USERNAME}/team_task/${taskId}`;
    }

    function closeViewTaskModal() {
      const modal = document.getElementById("view-task-modal");
      if (modal) modal.classList.remove("show");
    }

    // Обработчик закрытия модалки просмотра задачи по клику вне окна
    const viewTaskModal = document.getElementById("view-task-modal");

    // ===================== Team Functions =====================
    async function fetchTeamInfo() {
      try {
        let r = await fetch(`/{{ username }}/api/teams/${TEAM_ID}/info`, { headers: getHeaders() });
        let data = await r.json();
        setTeamNameInTopbar(data.name);
      } catch (error) {
        // Ошибка получения информации о команде
      }
    }

    // JS: Рендер участников в модалке редактирования команды (как в kanban.html)
    function renderEditTeamMembers(team) {
      const membersDiv = document.getElementById("edit-team-members");
      if (!membersDiv) return;
      membersDiv.innerHTML = "";
      // Лидер всегда сверху, без кнопок
      const leader = team.leader_name || team.leader;
      if (leader) {
        membersDiv.innerHTML += `
          <div class="member-item leader-member" style="display:flex;align-items:center;gap:10px;background:rgba(255,152,0,0.10);border:2px solid #ff9800;box-shadow:0 2px 8px #ff980033;">
            <span class="material-icons member-icon" style="color: #ff9800; font-size:1.3em;">star</span>
            <span class="member-info" style="font-weight:800;color:#ff9800;">${escapeHTML(leader)}</span>
            <span class="member-admin" style="background:#ff9800;color:#fff;font-weight:900;margin-left:10px;padding:4px 10px;border-radius:8px;font-size:1em;">админ</span>
          </div>
        `;
      }
      // Остальные участники
      (team.members || []).forEach((member) => {
        if (member !== leader) {
          membersDiv.innerHTML += `
            <div class="edit-team-member" style="display:flex;align-items:center;gap:10px;">
              <span class="material-icons member-icon" style="color:var(--accent);font-size:1.3em;">person</span>
              <span class="member-info">${escapeHTML(member)}</span>
              <button class="remove-member" onclick="removeMember('${member}')">
                <span class="material-icons">close</span>
              </button>
              <button class="make-leader" onclick="makeLeader('${member}')">
                <span class="material-icons">star</span>
              </button>
            </div>
          `;
        }
      });
    }
    // Функция передачи прав лидера (исправляем баг с выбором команды)
    function makeLeader(username) {
      const starBtn = event.currentTarget;
      if (!confirm(`Передать права администратора участнику ${username}?`)) return;

      // Получаем ID команды из модалки редактирования
      let currentEditTeamId = null;
      const editTeamModal = document.getElementById("edit-team-modal");
      if (editTeamModal && editTeamModal.dataset.teamId) {
        currentEditTeamId = editTeamModal.dataset.teamId;
      }
      if (!currentEditTeamId) return;

      starBtn.classList.add('btn-animate');
      fetch(`/{{ username }}/api/teams/${currentEditTeamId}/set_leader`, {
        method: "POST",
        headers: getHeaders(),
        body: JSON.stringify({ username }),
      }).then(async (resp) => {
        setTimeout(() => starBtn.classList.remove('btn-animate'), 350);
        if (resp.ok) {
          // Обновляем модалку только при успешном запросе
          openEditTeamModal(currentEditTeamId);
          // Также обновляем список команд в модалке "Мои команды"
          fetchTeams();
          // Обновляем список участников команды для автодополнения исполнителей
          if (currentEditTeamId == TEAM_ID) {
            const membersResponse = await fetch(`/{{ username }}/api/teams/${TEAM_ID}/members`, { headers: getHeaders() });
            const membersData = await membersResponse.json();
            MEMBERS = membersData.members || [];
          }
        } else {
          // Показываем ошибку, если запрос не удался
          resp.json().then(data => {
            alert(data.error || 'Ошибка передачи прав');
          });
        }
      }).catch(error => {
        setTimeout(() => starBtn.classList.remove('btn-animate'), 350);
        alert('Ошибка сети при передаче прав');
      });
    }
    // Функция удаления участника (исправляем баг с выбором команды)
    function removeMember(username) {
      const crossBtn = event.currentTarget;
      if (!confirm(`Удалить участника ${username}?`)) return;

      // Получаем ID команды из модалки редактирования
      let currentEditTeamId = null;
      const editTeamModal = document.getElementById("edit-team-modal");
      if (editTeamModal && editTeamModal.dataset.teamId) {
        currentEditTeamId = editTeamModal.dataset.teamId;
      }
      if (!currentEditTeamId) return;

      crossBtn.classList.add('btn-animate');
      fetch(`/{{ username }}/api/teams/${currentEditTeamId}/members`, {
        method: "POST",
        headers: getHeaders(),
        body: JSON.stringify({ username, remove: true }),
      }).then(async (resp) => {
        setTimeout(() => crossBtn.classList.remove('btn-animate'), 350);
        if (resp.ok) {
          // Обновляем модалку только при успешном запросе
          openEditTeamModal(currentEditTeamId);
          // Также обновляем список команд в модалке "Мои команды"
          fetchTeams();
          // Обновляем список участников команды для автодополнения исполнителей
          if (currentEditTeamId == TEAM_ID) {
            const membersResponse = await fetch(`/{{ username }}/api/teams/${TEAM_ID}/members`, { headers: getHeaders() });
            const membersData = await membersResponse.json();
            MEMBERS = membersData.members || [];
          }
        } else {
          // Показываем ошибку, если запрос не удался
          resp.json().then(data => {
            alert(data.error || 'Ошибка удаления участника');
          });
        }
      }).catch(error => {
        setTimeout(() => crossBtn.classList.remove('btn-animate'), 350);
        alert('Ошибка сети при удалении участника');
      });
    }

    // --- Анимация для крестика и звездочки ---
    // Добавить в style.css:
    // .btn-animate { transform: scale(1.25) rotate(-12deg); filter: brightness(1.3); transition: all 0.28s cubic-bezier(.4,1.4,.6,1); }

    // JS: красивые теги в карточках и просмотре задачи
    function renderTags(tags) {
      if (!tags || !tags.length) return "";
      return (
        `<div class='task-tags'>` +
        tags
          .map(
            (tag) =>
              `<span class='task-tag tag-${tag.toLowerCase()}'>${escapeHTML(
                tag
              )}</span>`
          )
          .join("") +
        `</div>`
      );
    }

    // ===================== Инициализация обработчиков модалок =====================
    // Универсальный обработчик закрытия модалок
    function bindModalCloseHandlers() {
      document.querySelectorAll(".modal-close").forEach((btn) => {
        btn.onclick = function (e) {
          e.preventDefault();
          e.stopPropagation();
          const modal = btn.closest(".modal");
          if (modal) modal.classList.remove("show");
        };
      });
      document.querySelectorAll(".modal").forEach((modal) => {
        // удалено: modal.onclick = function (e) { ... }
      });
    }

    // Вызвать после DOMContentLoaded
    bindModalCloseHandlers();

    // ===================== Team Creation =====================
    const createTeamForm = document.getElementById("create-team-form");
    if (createTeamForm) {
      createTeamForm.onsubmit = async function (e) {
        e.preventDefault();
        let name = document.getElementById("team-name-input").value.trim();
        if (!name) return;
        let resp = await fetch(`/{{ username }}/api/teams`, {
          method: "POST",
          headers: getHeaders(),
          body: JSON.stringify({ name }),
        });
        if (resp.ok) {
          let data = await resp.json();
          document.getElementById("create-team-modal").classList.remove("show");
          document.getElementById("create-team-form").reset();
          fetchTeams();
        } else {
          let data = await resp.json();
          document.getElementById("create-team-error").innerText =
            data.error || "Ошибка создания команды!";
        }
      };
    }

    const createTeamModal = document.getElementById("create-team-modal");

    // ===================== Profile Handlers =====================
    // Кнопка создания команды
    const openCreateTeamBtn = document.getElementById(
      "open-create-team-modal"
    );
    if (openCreateTeamBtn) {
      openCreateTeamBtn.onclick = function () {
        document.getElementById("create-team-modal").classList.add("show");
        document.getElementById("create-team-error").innerText = "";
        document.getElementById("team-name-input").value = "";
      };
    }

    // ===================== SPA: Fetch Board (эталон kanban.html, но для команды)
    async function fetchTeamBoard() {
      try {
        let [statuses, tasks, members] = await Promise.all([
          fetch(`/{{ username }}/api/teams/${TEAM_ID}/statuses`).then((r) =>
            r.json()
          ),
          fetch(`/{{ username }}/api/teams/${TEAM_ID}/tasks`).then((r) =>
            r.json()
          ),
          fetch(`/{{ username }}/api/teams/${TEAM_ID}/members`).then((r) =>
            r.json()
          ),
        ]);

        // Проверяем, что получили валидные данные
        if (Array.isArray(statuses)) {
          STATUSES = statuses;
        } else if (statuses && statuses.error) {
          STATUSES = [];
        } else {
          STATUSES = [];
        }

        if (Array.isArray(tasks)) {
          TASKS = tasks;
        } else if (tasks && tasks.tasks && Array.isArray(tasks.tasks)) {
          TASKS = tasks.tasks;
        } else if (tasks && tasks.error) {
          TASKS = [];
        } else {
          TASKS = [];
        }

        // Получаем участников с их ID
        MEMBERS = [];
        if (members && members.members && members.members.length > 0) {
          // Используем структуру с id и username из API
          MEMBERS = members.members;
        }

        // Удалить старую строку "Новый статус" если есть
        const oldAddStatusRow = document.getElementById("add-status-row");
        if (oldAddStatusRow && oldAddStatusRow.parentNode) {
          oldAddStatusRow.parentNode.removeChild(oldAddStatusRow);
        }
        renderBoard();
        bindAddStatusBtn();
      } catch (error) {
        STATUSES = [];
        TASKS = [];
        MEMBERS = [];
        renderBoard();
        bindAddStatusBtn();
      }
    }

    // ===================== Render (эталон kanban.html, но для команды)
    function renderBoard() {
      const row = document.getElementById("kanban-board");
      if (!row) {
        console.error("Element with id 'kanban-board' not found");
        return;
      }
      row.innerHTML = "";

      // Проверяем, что STATUSES и TASKS определены
      if (!STATUSES || !Array.isArray(STATUSES)) {
        STATUSES = [];
      }
      if (!TASKS || !Array.isArray(TASKS)) {
        TASKS = [];
      }
      if (!MEMBERS || !Array.isArray(MEMBERS)) {
        MEMBERS = [];
      }

      STATUSES.forEach((status) => {
        const col = document.createElement("div");
        col.className = "kanban-column";
        col.setAttribute("data-status-code", status.code);
        col.innerHTML = `
            <div class="kanban-col-title">
              <span>${escapeHTML(status.title)}</span>
            </div>
            <div class="kanban-tasks"></div>
            <button class="kanban-add-task-btn" data-status-code="${status.code
          }">
              <span class="material-icons">add</span>Добавить задачу
            </button>
          `;
        const tasksBlock = col.querySelector(".kanban-tasks");
        const tasks = TASKS.filter((t) => t.status === status.code);
        if (tasks.length === 0) {
          tasksBlock.innerHTML = `<div class="no-tasks">Нет задач</div>`;
        } else {
          tasks.forEach((task) => {
            tasksBlock.appendChild(createTaskCard(task));
          });
        }
        // Кнопка удаления статуса — крестик справа
        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn kanban-delete-status-btn";
        delBtn.title = "Удалить статус";
        delBtn.setAttribute("data-status-code", status.code);
        delBtn.innerHTML = `<span class="material-icons">close</span>`;
        col.querySelector(".kanban-col-title").appendChild(delBtn);
        row.appendChild(col);
      });
      bindAllHandlers();
      updateDnD();
      bindAddStatusBtn();
      bindTaskViewHandlers();
    }

    // ===================== Task View Handlers =====================
    function bindTaskViewHandlers() {
      document.querySelectorAll(".kanban-task").forEach((div) => {
        div.onclick = function (e) {
          if (e.target.closest(".edit-btn,.delete-btn")) return;
          const id = div.dataset.taskId;
          const task = TASKS.find((t) => t.id == id);
          if (task) openViewTaskModal(task);
        };
      });
    }

    // ===================== Task Card Creation =====================
    function getAvatarColor(id) {
      const colors = [
        "#5271ff",
        "#ff9800",
        "#ff5470",
        "#00b894",
        "#a29bfe",
        "#00bcd4",
      ];
      if (!id) return colors[0];
      let sum = 0;
      for (let i = 0; i < id.length; ++i) sum += id.charCodeAt(i);
      return colors[sum % colors.length];
    }
    function getInitials(name) {
      if (!name) return "?";
      return name[0].toUpperCase();
    }
    // Удаляет все HTML-теги и декодирует спецсимволы
    function stripTags(html) {
      let tmp = document.createElement("div");
      tmp.innerHTML = html;
      return tmp.textContent || tmp.innerText || "";
    }
    function createTaskCard(task) {
      const div = document.createElement("div");
      div.className = "kanban-task";
      div.dataset.taskId = task.id;
      let tagsHtml = "";
      if (task.tags && task.tags.length) {
        tagsHtml = renderTags(task.tags);
      }
      let dateHtml = task.due_date
        ? `<span class='task-date-badge'>${formatRuDate(task.due_date)}</span>`
        : "";
      let updatedByHtml = "";
      // Аватарка исполнителя
      let assignee = null;
      if (task.assignee_id && Array.isArray(MEMBERS)) {
        assignee = MEMBERS.find(
          (m) => m.username == task.assignee_id || m.id == task.assignee_id
        );
      }
      let avatarHtml = "";
      if (assignee) {
        avatarHtml = `<span class='task-avatar' data-username='${assignee.username}'>${getInitials(assignee.username)}</span>`;
      } else if (task.assignee_id) {
        avatarHtml = `<span class='task-avatar' data-username='${task.assignee_id}'>${getInitials(task.assignee_id)}</span>`;
      }
      let assigneeNameHtml = assignee
        ? `<span class='assignee-name'>${escapeHTML(assignee.username)}</span>`
        : task.assignee_id
          ? `<span class='assignee-name'>${escapeHTML(task.assignee_id)}</span>`
          : "<span style='color:#b9bccc'>Не назначено</span>";
      let descPreview = "";
      if (task.description) {
        let tmp = document.createElement("div");
        tmp.innerHTML = stripTags(task.description);
        descPreview = tmp.textContent || tmp.innerText || "";
        descPreview = truncate(descPreview, 120);
      }
      div.innerHTML = `
          <div class="task-header">
            <div class="task-title">${escapeHTML(truncate(task.text, 80))}</div>
            <div class="task-badges">${dateHtml}</div>
          </div>
          ${tagsHtml}
          ${descPreview
          ? `<div class="task-desc" style="white-space:pre-line;word-break:break-word;">${escapeHTML(descPreview)}</div>`
          : ""
        }
          <div class="task-meta">
            ${avatarHtml}
            ${assigneeNameHtml}
          </div>
          <div class="task-actions" style="margin-top: 6px; display: flex; flex-direction: row; gap: 6px; align-items: center;">
            <button class="icon-btn edit-btn" data-task-id="${task.id}"><span class="material-icons">edit</span></button>
            <button class="icon-btn delete-btn" data-task-id="${task.id}"><span class="material-icons">delete</span></button>
          </div>
        `;

      // Загружаем аватарку для исполнителя если есть
      if (assignee && assignee.username) {
        loadUserAvatarForTask(div, assignee.username);
      } else if (task.assignee_id) {
        loadUserAvatarForTask(div, task.assignee_id);
      }

      return div;
    }

    // Функция загрузки аватарки пользователя для карточки задачи
    async function loadUserAvatarForTask(taskElement, username) {
      try {
        const response = await fetch(`/api/avatar/${username}`, { headers: getHeaders() });
        const data = await response.json();

        if (data.avatar_url) {
          const avatarElement = taskElement.querySelector('.task-avatar');
          if (avatarElement) {
            // Создаем изображение аватарки
            const avatarImg = document.createElement('img');
            avatarImg.src = data.avatar_url;
            avatarImg.style.cssText = 'width: 100%; height: 100%; object-fit: cover; border-radius: 50%;';
            avatarImg.alt = username;

            // Очищаем содержимое и добавляем изображение
            avatarElement.innerHTML = '';
            avatarElement.appendChild(avatarImg);
          }
        }
      } catch (error) {
        console.error("Error loading avatar for task:", error);
      }
    }

    function truncate(str, len) {
      return str.length > len ? str.slice(0, len) + "…" : str;
    }
    function formatRuDate(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return d.toLocaleDateString("ru-RU");
    }
    function formatDateTime(dateStr) {
      if (!dateStr) return "";
      const d = new Date(dateStr);
      return d.toLocaleString("ru-RU");
    }
    function getStatusTitle(statusCode) {
      const status = STATUSES.find((s) => s.code === statusCode);
      return status ? status.title : statusCode;
    }
    // ===================== Вспомогательные функции =====================
    function escapeHTML(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#39;");
    }

    // ===================== Event Handlers =====================
    function bindAllHandlers() {
      // Кнопки добавить задачу
      document.querySelectorAll(".kanban-add-task-btn").forEach((btn) => {
        btn.onclick = function () {
          openTaskModal({ status: btn.getAttribute("data-status-code") });
        };
      });
      // Кнопки удалить статус
      document
        .querySelectorAll(".kanban-delete-status-btn")
        .forEach((btn) => {
          btn.onclick = async function () {
            if (!confirm("Удалить статус?")) return;
            let code = btn.getAttribute("data-status-code");
            let resp = await fetch(
              `/${USERNAME}/api/teams/${TEAM_ID}/statuses/${code}`,
              {
                method: "DELETE",
                headers: getHeaders(),
              }
            );
            if (resp.ok) {
              // Сообщаем через сокет
              if (socket)
                socket.emit("team_status_deleted", {
                  team_id: TEAM_ID,
                  code,
                });
              fetchTeamBoard();
            }
          };
        });
      // Кнопка добавить статус
      const addStatusBtn = document.getElementById("open-status-modal");
      if (addStatusBtn) addStatusBtn.onclick = openStatusModal;
      // Кнопки редактировать задачу
      document.querySelectorAll(".edit-btn").forEach((btn) => {
        btn.onclick = function () {
          let id = btn.getAttribute("data-task-id");
          let task = TASKS.find((t) => t.id == id);
          if (task) openTaskModal({ edit: true, ...task });
        };
      });
      // Кнопки удалить задачу
      document.querySelectorAll(".delete-btn").forEach((btn) => {
        btn.onclick = async function () {
          if (!confirm("Удалить задачу?")) return;
          let id = btn.getAttribute("data-task-id");
          let resp = await fetch(
            `/${USERNAME}/api/teams/${TEAM_ID}/tasks/${id}`,
            {
              method: "DELETE",
              headers: getHeaders(),
            }
          );
          if (resp.ok) fetchTeamBoard();
        };
      });
    }

    function updateDnD() {
      document.querySelectorAll(".kanban-tasks").forEach(function (col) {
        if (col._sortable) return;
        col._sortable = new Sortable(col, {
          group: "tasks",
          animation: 220,
          ghostClass: "drag-ghost",
          onEnd: async function (evt) {
            let orders = {};
            document
              .querySelectorAll(".kanban-tasks")
              .forEach(function (list) {
                const status =
                  list.closest(".kanban-column").dataset.statusCode ||
                  list
                    .closest(".kanban-column")
                    .getAttribute("data-status-code");
                orders[status] = Array.from(
                  list.querySelectorAll(".kanban-task")
                ).map((x) => +x.dataset.taskId);
              });
            let resp = await fetch(
              `/${USERNAME}/api/teams/${TEAM_ID}/tasks/order`,
              {
                method: "POST",
                headers: getHeaders(),
                body: JSON.stringify({ orders }),
              }
            );
            if (resp.ok) fetchTeamBoard();
          },
        });
      });
    }

    function bindAddStatusBtn() {
      const btn = document.getElementById("open-status-modal");
      if (btn) btn.onclick = openStatusModal;
    }

    // ===================== Topbar: название команды в Team-Nav =====================
    function setTeamNameInTopbar(teamName) {
      const badge = document.querySelector(".team-name-badge");
      if (badge) badge.textContent = teamName;
    }

    // После получения данных о команде:
    async function fetchTeamInfoAndSetName() {
      let r = await fetch(`/{{ username }}/api/teams/${TEAM_ID}/info`);
      let data = await r.json();
      setTeamNameInTopbar(data.name);
    }

    // Вызвать при загрузке страницы и после смены команды
    fetchTeamInfoAndSetName();

    // Инициализация при первой загрузке
    document.addEventListener("DOMContentLoaded", function () {
      // Функция для перетаскивания скролла
      function enableDragToScroll(selector) {
        const element = document.querySelector(selector);
        if (!element) return;

        let isDown = false;
        let startX;
        let scrollLeft;

        element.addEventListener("mousedown", (e) => {
          isDown = true;
          element.style.cursor = "grabbing";
          startX = e.pageX - element.offsetLeft;
          scrollLeft = element.scrollLeft;
        });

        element.addEventListener("mouseleave", () => {
          isDown = false;
          element.style.cursor = "grab";
        });

        element.addEventListener("mouseup", () => {
          isDown = false;
          element.style.cursor = "grab";
        });

        element.addEventListener("mousemove", (e) => {
          if (!isDown) return;
          e.preventDefault();
          const x = e.pageX - element.offsetLeft;
          const walk = (x - startX) * 2;
          element.scrollLeft = scrollLeft - walk;
        });
      }

      enableDragToScroll(".kanban-board");
    });

    // ========== Команды: логика и рендер ==========
    async function fetchTeams() {
      let r = await fetch(`/{{ username }}/api/teams/list`);
      let data = await r.json();
      TEAMS = Array.isArray(data.teams)
        ? data.teams
        : Array.isArray(data)
          ? data
          : [];
      renderTeams();
    }

    function renderTeams() {
      const list = document.getElementById("teams-list");
      if (!list) return;
      list.innerHTML = "";
      if (!TEAMS || TEAMS.length === 0) {
        list.innerHTML = `<div style="padding: 18px 0; text-align: center; color: var(--text-soft); font-size: 1.08em;">Нет команд</div>`;
        return;
      }
      TEAMS.forEach((team) => {
        const card = document.createElement("div");
        card.className = "team-card";
        card.dataset.teamId = team.id;
        let isLeader =
          team.leader_name === USERNAME ||
          team.leader === USERNAME ||
          team.is_leader;
        card.innerHTML = `
            <div class="team-header">
              <span class="team-icon material-icons">groups</span>
              <span class="team-title">${escapeHTML(
          team.name || team.title || "Без названия"
        )}</span>
              ${isLeader
            ? `<button class="icon-btn edit-team-btn" data-team-id="${team.id}" title="Редактировать"><span class="material-icons">edit</span></button>`
            : ""
          }
            </div>
            <div class="team-leader">
              <span class="material-icons member-icon" title="Лидер">star</span>
              <span>${escapeHTML(team.leader_name || team.leader || "-")}</span>
            </div>
            <div class="team-members">
              ${(team.members || [])
            .map((m) => `<span class="team-member">${escapeHTML(m)}</span>`)
            .join("")}
            </div>
            <div class="team-actions">
              <button class="plus-btn team-enter-btn" data-team-id="${team.id
          }"><span class="material-icons">login</span>Перейти</button>
              ${!isLeader
            ? `<button class="plus-btn danger-btn team-leave-btn" data-team-id="${team.id}"><span class="material-icons">logout</span>Выйти</button>`
            : ""
          }
            </div>
          `;
        list.appendChild(card);
      });

      // Назначение обработчиков только через JS
      document.querySelectorAll(".edit-team-btn").forEach((btn) => {
        btn.onclick = function (e) {
          e.preventDefault();
          const teamId = +btn.dataset.teamId;
          const team = TEAMS.find((t) => t.id === teamId);
          const isLeader =
            team &&
            (team.leader_name === USERNAME ||
              team.leader === USERNAME ||
              team.is_leader);
          if (!isLeader) return;
          openEditTeamModal(teamId);
        };
      });

      document.querySelectorAll(".team-leave-btn").forEach((btn) => {
        btn.onclick = async function (e) {
          e.preventDefault();
          if (!confirm("Выйти из команды?")) return;
          let teamId = btn.dataset.teamId;
          let resp = await fetch(
            `/{{ username }}/api/teams/${teamId}/leave`,
            {
              method: "POST",
              headers: getHeaders(),
            }
          );
          if (resp.ok) {
            // Перенаправляем на личную Kanban-доску
            window.location.href = `/{{ username }}/kanban`;
          } else {
            alert("Ошибка выхода из команды");
          }
        };
      });

      document.querySelectorAll(".team-enter-btn").forEach((btn) => {
        btn.onclick = function () {
          const teamId = btn.dataset.teamId;
          window.location = `/${USERNAME}/team?team_id=${teamId}`;
        };
      });
    }

    // ========== Модалка редактирования команды ==========
    async function openEditTeamModal(teamId) {
      let r = await fetch(`/{{ username }}/api/teams/${teamId}/info`);
      let data = await r.json();
      document.getElementById("edit-team-name").value = data.name;
      renderEditTeamMembers(data);

      // Сохраняем ID команды в dataset модалки
      const editTeamModal = document.getElementById("edit-team-modal");
      if (editTeamModal) {
        editTeamModal.dataset.teamId = teamId;
      }

      editTeamModal.classList.add("show");
      document.getElementById("edit-team-error").innerText = "";
      setTimeout(() => {
        document.getElementById("edit-team-name").focus();
      }, 120);
    }

    function closeEditTeamModal() {
      const editTeamModal = document.getElementById("edit-team-modal");
      if (editTeamModal) {
        editTeamModal.classList.remove("show");
        delete editTeamModal.dataset.teamId; // Очищаем ID команды
      }
      document.getElementById("edit-team-form").reset();
      document.getElementById("edit-team-members").innerHTML = "";
    }


    const addMemberBtn = document.getElementById("add-member-btn");
    if (addMemberBtn) {
      addMemberBtn.onclick = async function () {
        let username = document.getElementById("add-member-input").value.trim();
        if (!username) return;
        // Получаем ID команды из модалки редактирования
        let currentEditTeamId = null;
        const editTeamModal = document.getElementById("edit-team-modal");
        if (editTeamModal && editTeamModal.dataset.teamId) {
          currentEditTeamId = editTeamModal.dataset.teamId;
        }
        if (!currentEditTeamId) return;

        let resp = await fetch(`/{{ username }}/api/teams/${currentEditTeamId}/members`, {
          method: "POST",
          headers: getHeaders(),
          body: JSON.stringify({ username }),
        });
        if (resp.ok) {
          document.getElementById("add-member-input").value = "";
          openEditTeamModal(currentEditTeamId); // Обновляем модалку
          // Обновляем список участников команды для автодополнения исполнителей
          if (currentEditTeamId == TEAM_ID) {
            const membersResponse = await fetch(`/{{ username }}/api/teams/${TEAM_ID}/members`, { headers: getHeaders() });
            const membersData = await membersResponse.json();
            MEMBERS = membersData.members || [];
          }
        } else {
          let data = await resp.json();
          document.getElementById("edit-team-error").innerText =
            data.error || "Ошибка добавления!";
        }
      };
    }

    const editTeamForm = document.getElementById("edit-team-form");
    if (editTeamForm) {
      editTeamForm.onsubmit = async function (e) {
        e.preventDefault();
        let name = document.getElementById("edit-team-name").value.trim();
        // Получаем ID команды из модалки редактирования
        let currentEditTeamId = null;
        const editTeamModal = document.getElementById("edit-team-modal");
        if (editTeamModal && editTeamModal.dataset.teamId) {
          currentEditTeamId = editTeamModal.dataset.teamId;
        }
        if (!currentEditTeamId) return;

        let resp = await fetch(`/{{ username }}/api/teams/${currentEditTeamId}/edit`, {
          method: "POST",
          headers: getHeaders(),
          body: JSON.stringify({ name }),
        });
        if (resp.ok) {
          closeEditTeamModal();
          fetchTeams(); // Обновляем список команд
        } else {
          let data = await resp.json();
          document.getElementById("edit-team-error").innerText =
            data.error || "Ошибка сохранения!";
        }
      };
    }

    const deleteTeamBtn = document.getElementById("delete-team-btn");
    if (deleteTeamBtn) {
      deleteTeamBtn.onclick = async function () {
        if (!confirm("Удалить команду?")) return;
        // Получаем ID команды из модалки редактирования
        let currentEditTeamId = null;
        const editTeamModal = document.getElementById("edit-team-modal");
        if (editTeamModal && editTeamModal.dataset.teamId) {
          currentEditTeamId = editTeamModal.dataset.teamId;
        }
        if (!currentEditTeamId) return;

        let resp = await fetch(`/{{ username }}/api/teams/${currentEditTeamId}/delete`, {
          method: "POST",
          headers: getHeaders(),
        });
        if (resp.ok) {
          closeEditTeamModal();
          fetchTeams(); // Обновляем список команд
        } else {
          let data = await resp.json();
          document.getElementById("edit-team-error").innerText =
            data.error || "Ошибка удаления!";
        }
      };
    }

    // ====== Новый UX для профиля ======
    let editingField = null;
    const profileForm = document.getElementById('profile-form');
    const fields = ['email', 'country', 'fullname'];
    const errorDivs = {};
    fields.forEach(f => {
      const input = document.getElementById(`profile-${f}-input`);
      if (!input || !input.parentElement) return; // Исправление ошибки
      let err = document.createElement('div');
      err.className = 'profile-error';
      err.id = `profile-${f}-error`;
      err.style.display = 'none';
      input.parentElement.appendChild(err);
      errorDivs[f] = err;
      // Для страны — выпадающий список
      if (f === 'country') {
        input.type = 'text';
        let sel = document.createElement('select');
        sel.id = 'profile-country-select';
        sel.className = 'profile-input';
        sel.style.display = 'none';
        fillCountryOptions(sel, input.value);
        input.parentElement.insertBefore(sel, input);
        sel.onchange = function () {
          input.value = sel.value;
        };
        input.onfocus = function () {
          sel.style.display = 'block';
          input.style.display = 'none';
        };
        sel.onblur = function () {
          sel.style.display = 'none';
          input.style.display = 'block';
        };
      }
    });
    function startEditProfileField(field) {
      if (editingField && editingField !== field) finishEditProfileField(editingField, false);
      editingField = field;
      fields.forEach(f => {
        document.getElementById(`profile-${f}-input`).style.display = (f === field) ? 'block' : 'none';
        document.getElementById(`profile-${f}`).style.display = (f === field) ? 'none' : 'block';
        document.querySelector(`.profile-edit-btn[onclick*="${f}"]`).style.display = (f === field) ? 'none' : '';
        errorDivs[f].style.display = 'none';
      });
      document.getElementById('save-profile-btn').style.display = 'inline-flex';
      document.getElementById(`profile-${field}-input`).focus();
    }
    function finishEditProfileField(field, save = false) {
      const input = document.getElementById(`profile-${field}-input`);
      const value = document.getElementById(`profile-${field}`);
      if (save) {
        // Сохраняем только одно поле
        updateProfileField(field, input.value);
      } else {
        input.style.display = 'none';
        value.style.display = 'block';
        document.querySelector(`.profile-edit-btn[onclick*="${field}"]`).style.display = '';
        document.getElementById('save-profile-btn').style.display = 'none';
        editingField = null;
      }
    }
    function showProfileMessage(field, type, message) {
      const icon = type === 'error' ? '<span class="material-icons" style="font-size:1.2em;vertical-align:middle;">error_outline</span>' : '<span class="material-icons" style="color:#32c964;font-size:1.2em;vertical-align:middle;">check_circle</span>';
      errorDivs[field].innerHTML = icon + '<span style="margin-left:7px;">' + message + '</span>';
      errorDivs[field].className = 'profile-' + type + ' visible';
      errorDivs[field].classList.add('profile-anim-fade');
      setTimeout(() => { errorDivs[field].classList.remove('profile-anim-fade'); }, 1200);
      const input = document.getElementById(`profile-${field}-input`);
      input.classList.remove('error', 'success');
      if (type === 'error') input.classList.add('error');
      if (type === 'success') input.classList.add('success');
    }
    function updateProfileField(field, value) {
      errorDivs[field].style.display = 'none';
      fetch(`/${USERNAME}/api/update_profile`, {
        method: 'POST',
        headers: getHeaders(),
        body: JSON.stringify({ [field]: value })
      }).then(async resp => {
        let data = await resp.json();
        const input = document.getElementById(`profile-${field}-input`);
        if (resp.ok && data.success) {
          document.getElementById(`profile-${field}`).textContent = value;
          document.getElementById(`profile-${field}-input`).value = value;
          showProfileMessage(field, 'success', 'Успешно!');
          document.getElementById('save-profile-btn').classList.add('profile-anim-fade');
          setTimeout(() => { document.getElementById('save-profile-btn').classList.remove('profile-anim-fade'); }, 1200);
          finishEditProfileField(field, false);
        } else {
          showProfileMessage(field, 'error', data.error || 'Ошибка');
        }
      }).catch(() => {
        showProfileMessage(field, 'error', 'Ошибка сети');
      });
    }
    fields.forEach(f => {
      const input = document.getElementById(`profile-${f}-input`);
      if (!input) return; // Проверяем существование input
      input.addEventListener('keydown', e => { if (e.key === 'Enter') { finishEditProfileField(f, true); e.preventDefault(); } });
      input.addEventListener('blur', () => setTimeout(() => finishEditProfileField(f, false), 120));
      input.classList.remove('error', 'success');
    });
    if (profileForm) {
      profileForm.onsubmit = function (e) { e.preventDefault(); if (editingField) finishEditProfileField(editingField, true); };
    }

    // === Централизованный режим редактирования профиля ===
    let profileEditMode = false;
    const saveBtn = document.getElementById('save-profile-btn');
    const cancelBtn = document.getElementById('cancel-profile-btn');
    const errorDiv = document.getElementById('profile-error');
    const editProfileBtn = document.getElementById('edit-profile-btn');
    // fields уже объявлена выше в строке 2210

    function setProfileEditMode(on) {
      profileEditMode = on;
      fields.forEach(f => {
        const input = document.getElementById(`profile-${f}-input`);
        const value = document.getElementById(`profile-${f}`);
        if (!input || !value) return; // Проверяем существование элементов
        input.disabled = !on;
        input.style.display = on ? 'block' : 'none';
        value.style.display = on ? 'none' : 'block';
      });
      if (saveBtn) saveBtn.style.display = on ? 'inline-flex' : 'none';
      if (cancelBtn) cancelBtn.style.display = on ? 'inline-flex' : 'none';
    }

    if (editProfileBtn) {
      editProfileBtn.onclick = function () {
        setProfileEditMode(true);
      };
    }
    if (cancelBtn) {
      cancelBtn.onclick = function () {
        setProfileEditMode(false);
        resetProfileEditFields(window.lastProfileData || {});
        if (errorDiv) errorDiv.textContent = '';
      };
    }
    if (profileForm) {
      profileForm.onsubmit = async function (e) {
        e.preventDefault();
        if (saveBtn) saveBtn.disabled = true;
        if (errorDiv) errorDiv.textContent = '';
        const emailInput = document.getElementById('profile-email-input');
        const countrySelect = document.getElementById('profile-country-select');
        const fullnameInput = document.getElementById('profile-fullname-input');

        if (!emailInput || !countrySelect || !fullnameInput) return;

        const email = emailInput.value.trim();
        const country = countrySelect.value.trim();
        const fullname = fullnameInput.value.trim();
        try {
          const resp = await fetch(`/${USERNAME}/api/update_profile`, {
            method: 'POST',
            headers: getHeaders(),
            body: JSON.stringify({ email, country, fullname })
          });
          const data = await resp.json();
          if (resp.ok && data.success) {
            fields.forEach(f => {
              const valueElement = document.getElementById(`profile-${f}`);
              if (valueElement) {
                valueElement.textContent = eval(f);
              }
            });
            setProfileEditMode(false);
            if (errorDiv) {
              errorDiv.textContent = 'Профиль успешно обновлён!';
              errorDiv.className = 'profile-success visible';
              setTimeout(() => { errorDiv.className = 'profile-success'; errorDiv.textContent = ''; }, 2000);
            }
            window.lastProfileData = { email, country, fullname };
          } else {
            if (errorDiv) {
              errorDiv.textContent = data.error || 'Ошибка обновления профиля';
              errorDiv.className = 'profile-error visible';
            }
          }
        } catch {
          if (errorDiv) {
            errorDiv.textContent = 'Ошибка сети';
            errorDiv.className = 'profile-error visible';
          }
        }
        if (saveBtn) saveBtn.disabled = false;
      };
    }
    function resetProfileEditFields(data) {
      fields.forEach(f => {
        const input = document.getElementById(`profile-${f}-input`);
        const value = document.getElementById(`profile-${f}`);
        if (input && value) {
          input.value = data[f] || '';
          value.textContent = data[f] || '';
        }
      });
    }

    // Инициализация с проверками
    const emailInput = document.getElementById('profile-email-input');
    const countrySelect = document.getElementById('profile-country-select');
    const fullnameInput = document.getElementById('profile-fullname-input');

    window.lastProfileData = {
      email: emailInput ? emailInput.value : '',
      country: countrySelect ? countrySelect.value : '',
      fullname: fullnameInput ? fullnameInput.value : ''
    };
    setProfileEditMode(false);
  </script>
</body>

</html>