<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Kanban — {{ username }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
    <!-- Topbar -->
    <div class="topbar">
        <div class="topbar-left">
            <span class="material-icons" style="font-size:2em;color:var(--primary);">dashboard</span>
            <b style="font-size:1.2em;"><span style="color:var(--primary);">{{ username }}</span></b>
        </div>
        <div class="topbar-right">
            <button id="theme-toggle-btn" class="theme-toggle-btn" title="Переключить тему"><span class="material-icons" id="theme-icon">dark_mode</span></button>
            <a class="topbar-link" href="{{ url_for('logout', username=username) }}"><span class="material-icons">logout</span></a>
        </div>
    </div>
    <!-- Динамическая доска -->
    <div class="kanban-board"></div>

    <footer>
        © 2025 — Flask Kanban.
    </footer>

    <!-- Модалка: задача -->
    <div class="modal-backdrop" id="task-modal" style="display:none;">
        <div class="modal">
            <button class="modal-close" onclick="closeTaskModal()">&times;</button>
            <div class="modal-title" id="task-modal-title">Новая задача</div>
            <form class="modal-form" id="task-modal-form" autocomplete="off">
                <input type="hidden" name="edit_task_id" id="edit_task_id">
                <input type="text" name="task_text" id="task_text" placeholder="Название задачи" required maxlength="80">
                <textarea name="task_desc" id="task_desc" placeholder="Описание задачи (необязательно)" maxlength="400" rows="2"></textarea>
                <select name="task_status" id="task_status" required></select>
                <button type="submit" class="plus-btn" id="task-modal-submit-btn"><span class="material-icons">done</span>Сохранить</button>
            </form>
            <div id="task-modal-error" style="color:#d11a2a; text-align:center; margin-top:12px; font-size:1.08em;"></div>
        </div>
    </div>

    <!-- Модалка: новый статус -->
    <div class="modal-backdrop" id="status-modal" style="display:none;">
        <div class="modal">
            <button class="modal-close" onclick="closeStatusModal()">&times;</button>
            <div class="modal-title">Добавить новый статус</div>
            <form class="modal-form" id="status-modal-form" autocomplete="off">
                <input type="text" name="new_status_title" id="new_status_title" placeholder="Название статуса" maxlength="32" required>
                <button type="submit" class="plus-btn"><span class="material-icons">add</span>Добавить статус</button>
            </form>
            <div id="status-modal-error" style="color:#d11a2a; text-align:center; margin-top:12px; font-size:1.08em;"></div>
        </div>
    </div>

<script>
// ===================== Theme =====================
function setTheme(dark) {
    if (dark) {
        document.body.classList.add('dark');
        localStorage.setItem('kanban-theme', 'dark');
        document.getElementById('theme-icon').innerText = 'light_mode';
    } else {
        document.body.classList.remove('dark');
        localStorage.setItem('kanban-theme', 'light');
        document.getElementById('theme-icon').innerText = 'dark_mode';
    }
}
document.getElementById('theme-toggle-btn').onclick = function () {
    setTheme(!document.body.classList.contains('dark'));
};
(function () {
    const theme = localStorage.getItem('kanban-theme');
    setTheme(theme === 'dark');
})();

// ===================== State =====================
let STATUSES = [];
let TASKS = [];
let USERNAME = "{{ username }}";

// ===================== SPA: Fetch Board =====================
async function fetchBoard() {
    let [statuses, tasks] = await Promise.all([
        fetch(`/${USERNAME}/api/statuses`).then(r=>r.json()),
        fetch(`/${USERNAME}/api/tasks`).then(r=>r.json())
    ]);
    // Сервер отдаёт tasks в {"tasks": [...]}, если поменяешь — поправь тут!
    if (Array.isArray(tasks)) TASKS = tasks;
    else TASKS = tasks.tasks;
    STATUSES = statuses;
    renderBoard();
}

// ===================== Render =====================
function renderBoard() {
    const board = document.querySelector('.kanban-board');
    board.innerHTML = '';
    // Колонки
    STATUSES.forEach(status => {
        const col = document.createElement('div');
        col.className = 'kanban-column';
        col.dataset.status = status.code;
        col.innerHTML = `
            <div class="kanban-col-title">
                <span class="status-title" title="${status.title}">${status.title}</span>
                <button class="icon-btn delete-status-btn" data-status-code="${status.code}" title="Удалить статус">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="kanban-tasks" id="tasks-${status.code}"></div>
            <button class="plus-btn kanban-add-task-btn" data-status-code="${status.code}">
                <span class="material-icons">add</span>
                <span>Добавить задачу</span>
            </button>
        `;
        board.appendChild(col);
        // Задачи
        const tasksBlock = col.querySelector('.kanban-tasks');
        const tasks = TASKS.filter(t => t.status === status.code);
        if (tasks.length === 0) {
            tasksBlock.innerHTML = `<div class="kanban-task-empty">Нет задач</div>`;
        } else {
            tasks.forEach(task => {
                tasksBlock.appendChild(createTaskCard(task));
            });
        }
    });
    // Кнопка "новый статус"
    const addStatusCol = document.createElement('div');
    addStatusCol.className = 'kanban-column add-status-column';
    addStatusCol.innerHTML = `
        <button id="open-status-modal" class="kanban-add-status-btn">
            <span class="material-icons">add_box</span>
            <span>Новый статус</span>
        </button>
    `;
    board.appendChild(addStatusCol);

    bindAllHandlers();
    updateDnD();
}

// Создание карточки задачи
function createTaskCard(task) {
    const div = document.createElement('div');
    div.className = 'kanban-task';
    div.dataset.taskId = task.id;
    div.innerHTML = `
        <div class="task-main" title="${escapeHTML(task.text)}">${escapeHTML(truncate(task.text, 80))}</div>
        ${task.desc ? `<div class="task-desc" title="${escapeHTML(task.desc)}">${escapeHTML(truncate(task.desc, 120))}</div>` : ''}
        <div class="task-actions">
            <button class="icon-btn edit-btn" title="Редактировать" data-task-id="${task.id}">
                <span class="material-icons">edit</span>
            </button>
            <button class="icon-btn delete-btn" title="Удалить" data-task-id="${task.id}">
                <span class="material-icons">delete</span>
            </button>
        </div>
    `;
    return div;
}

function escapeHTML(str) { return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
function truncate(str, len) { return str.length > len ? str.slice(0, len) + '…' : str; }

// ===================== Drag & Drop =====================
function updateDnD() {
    document.querySelectorAll('.kanban-tasks').forEach(function (col) {
        if(col._sortable) return;
        col._sortable = new Sortable(col, {
            group: 'tasks',
            animation: 220,
            ghostClass: 'drag-ghost',
            onEnd: async function (evt) {
                let orders = {};
                document.querySelectorAll('.kanban-tasks').forEach(function (list) {
                    const status = list.closest('.kanban-column').dataset.status;
                    orders[status] = Array.from(list.querySelectorAll('.kanban-task')).map(x => +x.dataset.taskId);
                });
                let resp = await fetch(`/${USERNAME}/api/tasks/order`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orders })
                });
                if (resp.ok) fetchBoard();
            }
        });
    });
}

// ===================== Modal: Task =====================
function openTaskModal({ edit = false, id = null, text = '', desc = '', status = '' } = {}) {
    document.getElementById('task-modal-title').innerText = edit ? 'Редактировать задачу' : 'Новая задача';
    document.getElementById('edit_task_id').value = id || '';
    document.getElementById('task_text').value = text || '';
    document.getElementById('task_desc').value = desc || '';
    // Рендерим опции статусов каждый раз, чтобы не устарели
    let statusSel = document.getElementById('task_status');
    statusSel.innerHTML = STATUSES.map(s =>
        `<option value="${s.code}"${(status || STATUSES[0].code) === s.code ? ' selected' : ''}>${escapeHTML(s.title)}</option>`
    ).join('');
    document.getElementById('task-modal-error').innerText = "";
    document.getElementById('task-modal').style.display = 'flex';
    setTimeout(() => { document.getElementById('task_text').focus(); }, 120);
}
function closeTaskModal() {
    document.getElementById('task-modal').style.display = 'none';
    document.getElementById('task-modal-form').reset();
}
document.getElementById('task-modal-form').onsubmit = async function (e) {
    e.preventDefault();
    let text = this.task_text.value.trim();
    let desc = this.task_desc.value.trim();
    let status = this.task_status.value;
    let id = this.edit_task_id.value;
    let method = id ? 'PATCH' : 'POST';
    let url = `/${USERNAME}/api/tasks` + (id ? `/${id}` : '');
    let resp = await fetch(url, {
        method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, desc, status })
    });
    if (resp.ok) {
        closeTaskModal();
        fetchBoard();
    } else document.getElementById('task-modal-error').innerText = "Ошибка сохранения!";
};
document.getElementById('task-modal').onclick = function (e) { if (e.target === this) closeTaskModal(); };

// ===================== Modal: Status =====================
function openStatusModal() {
    document.getElementById('status-modal').style.display = 'flex';
    document.getElementById('status-modal-error').innerText = "";
    document.getElementById('new_status_title').value = "";
    setTimeout(() => { document.getElementById('new_status_title').focus(); }, 120);
}
function closeStatusModal() {
    document.getElementById('status-modal').style.display = 'none';
    document.getElementById('status-modal-form').reset();
}
document.getElementById('status-modal-form').onsubmit = async function (e) {
    e.preventDefault();
    let title = this.new_status_title.value.trim();
    if (!title) return;
    let code = 's' + Date.now();
    let resp = await fetch(`/${USERNAME}/api/statuses`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title, code })
    });
    if (resp.ok) {
        closeStatusModal();
        fetchBoard();
    }
    else document.getElementById('status-modal-error').innerText = "Ошибка добавления статуса!";
};
document.getElementById('status-modal').onclick = function (e) { if (e.target === this) closeStatusModal(); };

// ===================== Handlers =====================
function bindAllHandlers() {
    // Кнопка "добавить задачу"
    document.querySelectorAll('.kanban-add-task-btn').forEach(btn => {
        btn.onclick = function () {
            openTaskModal({ status: btn.dataset.statusCode });
        };
    });
    // Кнопка "редактировать"
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.onclick = function () {
            let taskId = btn.dataset.taskId;
            let task = TASKS.find(t => String(t.id) === String(taskId));
            if (task) {
                openTaskModal({
                    edit: true,
                    id: task.id,
                    text: task.text,
                    desc: task.desc,
                    status: task.status
                });
            }
        };
    });
    // Кнопка "удалить"
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.onclick = async function () {
            if (!confirm('Удалить задачу?')) return;
            let taskId = btn.dataset.taskId;
            let resp = await fetch(`/${USERNAME}/api/tasks/${taskId}`, { method: 'DELETE' });
            if (resp.ok) fetchBoard();
            else alert('Ошибка удаления!');
        };
    });
    // Кнопка "добавить статус"
    let addStatusBtn = document.getElementById('open-status-modal');
    if(addStatusBtn){
        addStatusBtn.onclick = openStatusModal;
    }
    // Кнопка "удалить статус"
    document.querySelectorAll('.delete-status-btn').forEach(btn => {
        btn.onclick = async function () {
            if (!confirm('Удалить статус?')) return;
            let code = btn.dataset.statusCode;
            let resp = await fetch(`/${USERNAME}/api/statuses/${code}`, { method: 'DELETE' });
            if (resp.ok) fetchBoard();
            else alert('Ошибка удаления статуса!');
        };
    });
}
fetchBoard();
</script>
</body>
</html>