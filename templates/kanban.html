<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Kanban — {{ username }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />
    <link
      href="{{ url_for('static', filename='style.css') }}"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
  </head>
  <body>
    <!-- Topbar -->
    <header class="topbar">
      <div class="topbar-inner">
        <div class="topbar-nav">
          <button
            class="nav-btn{% if active_page == 'kanban' %} active{% endif %}"
            id="kanban-btn"
            type="button"
          >
            <span class="material-icons">dashboard</span>
            <span>Kanban</span>
          </button>
          <button
            class="nav-btn{% if active_page == 'todo' %} active{% endif %}"
            id="todo-btn"
            type="button"
          >
            <span class="material-icons">check_circle</span>
            <span>ToDo‑лист</span>
          </button>
        </div>
        <div class="topbar-right">
          <button
            id="theme-toggle-btn"
            class="theme-toggle-btn"
            title="Переключить тему"
          >
            <span class="material-icons" id="theme-icon">dark_mode</span>
          </button>
          <div class="user-menu-wrap">
            <button id="user-menu-btn" class="user-menu-btn" type="button">
              <span class="material-icons">account_circle</span>
              <span class="user-menu-name">{{ username }}</span>
              <span class="material-icons">expand_more</span>
            </button>
            <div class="user-dropdown" id="user-dropdown">
              <button class="dropdown-item" id="profile-btn" type="button">
                <span class="material-icons">person</span>Профиль
              </button>
              <button
                class="dropdown-item"
                id="change-password-btn"
                type="button"
              >
                <span class="material-icons">lock</span>Сменить пароль
              </button>
              <button class="dropdown-item" id="logout-btn" type="button">
                <span class="material-icons">logout</span>Выйти
              </button>
            </div>
          </div>
        </div>
      </div>
    </header>
    <!-- Kanban board -->
    <main>
      <div class="kanban-board"></div>
    </main>
    <footer>© 2025 — Flask Kanban.</footer>

    <!-- Модалка: профиль пользователя -->
    <div class="modal-backdrop" id="profile-modal" style="display: none">
      <div class="modal modal-profile">
        <button class="modal-close profile-close" type="button" title="Закрыть">
          <span class="material-icons">close</span>
        </button>
        <div class="profile-card">
          <div class="profile-avatar">
            <span class="material-icons">account_circle</span>
          </div>
          <div class="profile-username" id="profile-username"></div>
          <div class="profile-fields">
            <div class="profile-field">
              <span class="profile-label">E-mail:</span>
              <span class="profile-value" id="profile-email"></span>
            </div>
            <div class="profile-field">
              <span class="profile-label">Страна:</span>
              <span class="profile-value" id="profile-country"></span>
            </div>
            <div class="profile-field">
              <span class="profile-label">Имя:</span>
              <span class="profile-value" id="profile-fullname"></span>
            </div>
          </div>
          <button class="plus-btn profile-close" type="button">Закрыть</button>
        </div>
      </div>
    </div>
    <!-- Модалка: смена пароля -->
    <div
      class="modal-backdrop"
      id="change-password-modal"
      style="display: none"
    >
      <div class="modal modal-password">
        <button
          class="modal-close"
          onclick="closeChangePasswordModal()"
          type="button"
          aria-label="Закрыть"
        >
          <span class="material-icons">close</span>
        </button>
        <div class="modal-password-content">
          <div class="modal-password-icon">
            <span class="material-icons">lock_reset</span>
          </div>
          <div class="modal-title modal-password-title">Смена пароля</div>
          <form class="modal-form" id="change-password-form" autocomplete="off">
            <input
              type="password"
              name="old_password"
              id="old_password"
              placeholder="Старый пароль"
              required
            />
            <input
              type="password"
              name="new_password"
              id="new_password"
              placeholder="Новый пароль"
              required
              minlength="3"
            />
            <input
              type="password"
              name="new_password2"
              id="new_password2"
              placeholder="Повторите новый пароль"
              required
              minlength="3"
            />
            <button type="submit" class="plus-btn">
              <span class="material-icons">sync_lock</span>
              Сменить
            </button>
            <div id="change-password-error" class="modal-error"></div>
          </form>
        </div>
      </div>
    </div>
    <!-- Модалка: задача -->
    <div class="modal-backdrop" id="task-modal" style="display: none">
      <div class="modal">
        <button class="modal-close" onclick="closeTaskModal()">&times;</button>
        <div class="modal-title" id="task-modal-title">Новая задача</div>
        <form class="modal-form" id="task-modal-form" autocomplete="off">
          <input type="hidden" name="edit_task_id" id="edit_task_id" />
          <input
            type="text"
            name="task_text"
            id="task_text"
            placeholder="Название задачи"
            required
            maxlength="80"
          />
          <textarea
            name="task_description"
            id="task_description"
            placeholder="Описание задачи (необязательно)"
            maxlength="400"
            rows="2"
          ></textarea>
          <select name="task_status" id="task_status" required></select>
          <button type="submit" class="plus-btn" id="task-modal-submit-btn">
            <span class="material-icons">done</span>Сохранить
          </button>
        </form>
        <div
          id="task-modal-error"
          style="
            color: #d11a2a;
            text-align: center;
            margin-top: 12px;
            font-size: 1.08em;
          "
        ></div>
      </div>
    </div>
    <!-- Модалка: новый статус -->
    <div class="modal-backdrop" id="status-modal" style="display: none">
      <div class="modal">
        <button class="modal-close" onclick="closeStatusModal()">
          &times;
        </button>
        <div class="modal-title">Добавить новый статус</div>
        <form class="modal-form" id="status-modal-form" autocomplete="off">
          <input
            type="text"
            name="new_status_title"
            id="new_status_title"
            placeholder="Название статуса"
            maxlength="32"
            required
          />
          <button type="submit" class="plus-btn">
            <span class="material-icons">add</span>Добавить статус
          </button>
        </form>
        <div
          id="status-modal-error"
          style="
            color: #d11a2a;
            text-align: center;
            margin-top: 12px;
            font-size: 1.08em;
          "
        ></div>
      </div>
    </div>
    <script>
      // ===================== Theme =====================
      function setTheme(dark) {
        if (dark) {
          document.body.classList.add("dark");
          localStorage.setItem("kanban-theme", "dark");
          document.getElementById("theme-icon").innerText = "light_mode";
        } else {
          document.body.classList.remove("dark");
          localStorage.setItem("kanban-theme", "light");
          document.getElementById("theme-icon").innerText = "dark_mode";
        }
      }
      document.getElementById("theme-toggle-btn").onclick = function () {
        setTheme(!document.body.classList.contains("dark"));
      };
      (function () {
        const theme = localStorage.getItem("kanban-theme");
        setTheme(theme === "dark");
      })();

      // ========== User Dropdown ==========
      const userMenuBtn = document.getElementById("user-menu-btn");
      const userDropdown = document.getElementById("user-dropdown");
      userMenuBtn.onclick = function (e) {
        e.stopPropagation();
        userDropdown.classList.toggle("show");
      };
      document.body.addEventListener("click", function () {
        userDropdown.classList.remove("show");
      });
      userDropdown.onclick = function (e) {
        e.stopPropagation();
      };

      // Открытие профиля
      document.getElementById("profile-btn").onclick = async function () {
        userDropdown.classList.remove("show");
        let r = await fetch(`/api/profile/{{ username }}`);
        let data = await r.json();
        document.getElementById(
          "profile-username"
        ).innerHTML = `<span>${data.username}</span>`;
        document.getElementById("profile-email").textContent =
          data.email || "-";
        document.getElementById("profile-country").textContent =
          data.country || "-";
        document.getElementById("profile-fullname").textContent =
          data.fullname || "-";
        document.getElementById("profile-modal").style.display = "flex";
      };
      function closeProfileModal() {
        document.getElementById("profile-modal").style.display = "none";
      }
      document.querySelectorAll(".profile-close").forEach((btn) => {
        btn.onclick = closeProfileModal;
      });
      document.getElementById("profile-modal").onclick = function (e) {
        if (e.target === this) closeProfileModal();
      };

      // ========== Смена пароля ==========
      document.getElementById("change-password-btn").onclick = function () {
        userDropdown.classList.remove("show");
        document.getElementById("change-password-form").reset();
        document.getElementById("change-password-error").innerText = "";
        document.getElementById("change-password-modal").style.display = "flex";
      };
      function closeChangePasswordModal() {
        document.getElementById("change-password-modal").style.display = "none";
      }
      document.getElementById("change-password-modal").onclick = function (e) {
        if (e.target === this) closeChangePasswordModal();
      };
      document.getElementById("change-password-form").onsubmit =
        async function (e) {
          e.preventDefault();
          let oldPass = document.getElementById("old_password").value;
          let newPass = document.getElementById("new_password").value;
          let newPass2 = document.getElementById("new_password2").value;
          let err = document.getElementById("change-password-error");
          if (newPass !== newPass2) {
            err.innerText = "Пароли не совпадают!";
            return;
          }
          let resp = await fetch(`/{{ username }}/api/change_password`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              old_password: oldPass,
              new_password: newPass,
            }),
          });
          if (resp.ok) {
            err.style.color = "#32c964";
            err.innerText = "Пароль изменён!";
            setTimeout(closeChangePasswordModal, 900);
          } else {
            err.style.color = "#d11a2a";
            let data = await resp.json();
            err.innerText = data.error || "Ошибка смены пароля!";
          }
        };

      // ===================== State =====================
      let STATUSES = [];
      let TASKS = [];
      let USERNAME = "{{ username }}";

      // ===================== SPA: Fetch Board =====================
      async function fetchBoard() {
        let [statuses, tasks] = await Promise.all([
          fetch(`/${USERNAME}/api/statuses`).then((r) => r.json()),
          fetch(`/${USERNAME}/api/tasks`).then((r) => r.json()),
        ]);
        if (Array.isArray(tasks)) TASKS = tasks;
        else TASKS = tasks.tasks;
        STATUSES = statuses;
        renderBoard();
      }

      // ===================== Render =====================
      function renderBoard() {
        const board = document.querySelector(".kanban-board");
        board.innerHTML = "";
        STATUSES.forEach((status) => {
          const col = document.createElement("div");
          col.className = "kanban-column";
          col.dataset.status = status.code;
          col.innerHTML = `
          <div class="kanban-col-title">
            <span class="status-title" title="${status.title}">${status.title}</span>
            <button class="icon-btn delete-status-btn" data-status-code="${status.code}" title="Удалить статус">
              <span class="material-icons">close</span>
            </button>
          </div>
          <div class="kanban-tasks" id="tasks-${status.code}"></div>
          <button class="plus-btn kanban-add-task-btn" data-status-code="${status.code}">
            <span class="material-icons">add</span>
            <span>Добавить задачу</span>
          </button>
        `;
          board.appendChild(col);
          const tasksBlock = col.querySelector(".kanban-tasks");
          const tasks = TASKS.filter((t) => t.status === status.code);
          if (tasks.length === 0) {
            tasksBlock.innerHTML = `<div class="kanban-task-empty">Нет задач</div>`;
          } else {
            tasks.forEach((task) => {
              tasksBlock.appendChild(createTaskCard(task));
            });
          }
        });
        // Кнопка "новый статус"
        const addStatusCol = document.createElement("div");
        addStatusCol.className = "kanban-column add-status-column";
        addStatusCol.innerHTML = `
        <button id="open-status-modal" class="kanban-add-status-btn">
          <span class="material-icons">add_box</span>
          <span>Новый статус</span>
        </button>
      `;
        board.appendChild(addStatusCol);

        bindAllHandlers();
        updateDnD();
      }

      function createTaskCard(task) {
        const div = document.createElement("div");
        div.className = "kanban-task";
        div.dataset.taskId = task.id;
        div.innerHTML = `
        <div class="task-main" title="${escapeHTML(task.text)}">${escapeHTML(
          truncate(task.text, 80)
        )}</div>
        ${
          task.description
            ? `<div class="task-description" title="${escapeHTML(
                task.description
              )}">${escapeHTML(truncate(task.description, 120))}</div>`
            : ""
        }
        <div class="task-actions">
          <button class="icon-btn edit-btn" title="Редактировать" data-task-id="${
            task.id
          }">
            <span class="material-icons">edit</span>
          </button>
          <button class="icon-btn delete-btn" title="Удалить" data-task-id="${
            task.id
          }">
            <span class="material-icons">delete</span>
          </button>
        </div>
      `;
        return div;
      }
      function escapeHTML(str) {
        return String(str).replace(
          /[&<>"']/g,
          (s) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            }[s])
        );
      }
      function truncate(str, len) {
        return str.length > len ? str.slice(0, len) + "…" : str;
      }

      // ===================== Drag & Drop =====================
      function updateDnD() {
        document.querySelectorAll(".kanban-tasks").forEach(function (col) {
          if (col._sortable) return;
          col._sortable = new Sortable(col, {
            group: "tasks",
            animation: 220,
            ghostClass: "drag-ghost",
            onEnd: async function (evt) {
              let orders = {};
              document
                .querySelectorAll(".kanban-tasks")
                .forEach(function (list) {
                  const status = list.closest(".kanban-column").dataset.status;
                  orders[status] = Array.from(
                    list.querySelectorAll(".kanban-task")
                  ).map((x) => +x.dataset.taskId);
                });
              let resp = await fetch(`/${USERNAME}/api/tasks/order`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ orders }),
              });
              if (resp.ok) fetchBoard();
            },
          });
        });
      }
      document.getElementById("logout-btn").onclick = function () {
        window.location.href = "{{ url_for('logout', username=username) }}";
      };
      // ===================== Modal: Task =====================
      function openTaskModal({
        edit = false,
        id = null,
        text = "",
        description = "",
        status = "",
      } = {}) {
        document.getElementById("task-modal-title").innerText = edit
          ? "Редактировать задачу"
          : "Новая задача";
        document.getElementById("edit_task_id").value = id || "";
        document.getElementById("task_text").value = text || "";
        document.getElementById("task_description").value = description || "";
        let statusSel = document.getElementById("task_status");
        statusSel.innerHTML = STATUSES.map(
          (s) =>
            `<option value="${s.code}"${
              (status || STATUSES[0].code) === s.code ? " selected" : ""
            }>${escapeHTML(s.title)}</option>`
        ).join("");
        document.getElementById("task-modal-error").innerText = "";
        document.getElementById("task-modal").style.display = "flex";
        setTimeout(() => {
          document.getElementById("task_text").focus();
        }, 120);
      }
      function closeTaskModal() {
        document.getElementById("task-modal").style.display = "none";
        document.getElementById("task-modal-form").reset();
      }
      document.getElementById("task-modal-form").onsubmit = async function (e) {
        e.preventDefault();
        let text = this.task_text.value.trim();
        let description = this.task_description.value.trim();
        let status = this.task_status.value;
        let id = this.edit_task_id.value;
        let method = id ? "PATCH" : "POST";
        let url = `/${USERNAME}/api/tasks` + (id ? `/${id}` : "");
        let resp = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, description, status }),
        });
        if (resp.ok) {
          closeTaskModal();
          fetchBoard();
        } else
          document.getElementById("task-modal-error").innerText =
            "Ошибка сохранения!";
      };
      document.getElementById("task-modal").onclick = function (e) {
        if (e.target === this) closeTaskModal();
      };

      // ===================== Modal: Status =====================
      function openStatusModal() {
        document.getElementById("status-modal").style.display = "flex";
        document.getElementById("status-modal-error").innerText = "";
        document.getElementById("new_status_title").value = "";
        setTimeout(() => {
          document.getElementById("new_status_title").focus();
        }, 120);
      }
      function closeStatusModal() {
        document.getElementById("status-modal").style.display = "none";
        document.getElementById("status-modal-form").reset();
      }
      document.getElementById("status-modal-form").onsubmit = async function (
        e
      ) {
        e.preventDefault();
        let title = this.new_status_title.value.trim();
        if (!title) return;
        let code = "s" + Date.now();
        let resp = await fetch(`/${USERNAME}/api/statuses`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, code }),
        });
        if (resp.ok) {
          closeStatusModal();
          fetchBoard();
        } else
          document.getElementById("status-modal-error").innerText =
            "Ошибка добавления статуса!";
      };
      document.getElementById("status-modal").onclick = function (e) {
        if (e.target === this) closeStatusModal();
      };

      // ===================== Handlers =====================
      function bindAllHandlers() {
        document.querySelectorAll(".kanban-add-task-btn").forEach((btn) => {
          btn.onclick = function () {
            openTaskModal({ status: btn.dataset.statusCode });
          };
        });
        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.onclick = function () {
            let taskId = btn.dataset.taskId;
            let task = TASKS.find((t) => String(t.id) === String(taskId));
            if (task) {
              openTaskModal({
                edit: true,
                id: task.id,
                text: task.text,
                description: task.description,
                status: task.status,
              });
            }
          };
        });
        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.onclick = async function () {
            if (!confirm("Удалить задачу?")) return;
            let taskId = btn.dataset.taskId;
            let resp = await fetch(`/${USERNAME}/api/tasks/${taskId}`, {
              method: "DELETE",
            });
            if (resp.ok) fetchBoard();
            else alert("Ошибка удаления!");
          };
        });
        let addStatusBtn = document.getElementById("open-status-modal");
        if (addStatusBtn) {
          addStatusBtn.onclick = openStatusModal;
        }
        document.querySelectorAll(".delete-status-btn").forEach((btn) => {
          btn.onclick = async function () {
            if (!confirm("Удалить статус?")) return;
            let code = btn.dataset.statusCode;
            let resp = await fetch(`/${USERNAME}/api/statuses/${code}`, {
              method: "DELETE",
            });
            if (resp.ok) fetchBoard();
            else alert("Ошибка удаления статуса!");
          };
        });
      }
      fetchBoard();

      // Topbar навигация
      document.getElementById("kanban-btn").onclick = () => {
        location.href = `/${USERNAME}/kanban`;
      };
      document.getElementById("todo-btn").onclick = () => {
        location.href = `/${USERNAME}/todo`;
      };
      // выделение активного:
      if (window.location.pathname.includes("/kanban")) {
        document.getElementById("kanban-btn").classList.add("active");
      } else {
        document.getElementById("todo-btn").classList.add("active");
      }
    </script>
  </body>
</html>
